<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED Studio Pro - Engineering Master</title>
    <!-- 載入核心框架 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入點陣與工程字體 -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        body { 
            background-color: #020617; 
            color: #f1f5f9; 
            font-family: 'JetBrains Mono', monospace; 
            margin: 0; 
            overflow: hidden; 
        }
        
        /* 自定義滾動條 */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #334155; }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
            height: 1.5rem;
        }

        .led-dot-matrix {
            font-family: 'DotGothic16', sans-serif;
            text-shadow: 0 0 8px currentColor;
        }

        /* 確保 Canvas 呈現像素風格，不模糊 */
        canvas { 
            image-rendering: pixelated; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ═══════════════════════════════════════════════════════════════════════════════
        // LED STUDIO PRO - 完整整合版 v6 (Smart Zoom)
        // ═══════════════════════════════════════════════════════════════════════════════
        
        const { useState, useMemo, useRef, useEffect } = React;

        // ────────────────────────────────────────────────────────────────────────────────
        // [SECTION 1] 5x7 點陣字庫定義 (用於 Canvas 緩衝區繪製)
        // ────────────────────────────────────────────────────────────────────────────────
        const FONT_5X7 = {
            32:[0,0,0,0,0],33:[0,0,95,0,0],34:[0,7,0,7,0],35:[20,127,20,127,20],36:[36,42,127,42,18],37:[35,19,8,100,98],38:[54,73,85,34,80],39:[0,5,3,0,0],
            40:[0,28,34,65,0],41:[0,65,34,28,0],42:[20,8,62,8,20],43:[8,8,62,8,8],44:[0,80,48,0,0],45:[8,8,8,8,8],46:[0,96,96,0,0],47:[32,16,8,4,2],
            48:[62,81,73,69,62],49:[0,66,127,64,0],50:[66,97,81,73,70],51:[33,65,69,75,49],52:[24,20,18,127,16],53:[39,69,69,69,57],54:[60,74,73,73,48],55:[1,113,9,5,3],
            56:[54,73,73,73,54],57:[6,73,73,41,30],58:[0,54,54,0,0],59:[0,86,54,0,0],60:[8,20,34,65,0],61:[20,20,20,20,20],62:[0,65,34,20,8],63:[2,1,81,9,6],
            64:[50,73,121,65,62],65:[126,17,17,17,126],66:[127,73,73,73,54],67:[62,65,65,65,34],68:[127,65,65,34,28],69:[127,73,73,73,65],70:[127,9,9,9,1],
            71:[62,65,73,73,122],72:[127,8,8,8,127],73:[0,65,127,65,0],74:[32,64,65,63,1],75:[127,8,20,34,65],76:[127,64,64,64,64],77:[127,2,12,2,127],
            78:[127,4,8,16,127],79:[62,65,65,65,62],80:[127,9,9,9,6],81:[62,65,81,33,94],82:[127,9,25,41,70],83:[70,73,73,73,49],84:[1,1,127,1,1],
            85:[63,64,64,64,63],86:[31,32,64,32,31],87:[63,64,56,64,63],88:[99,20,8,20,99],89:[7,8,112,8,7],90:[97,81,73,69,67]
        };

        // 2. 數位風格字庫 (7-Segment Style)
        const FONT_DIGITAL = {
            45: [8, 8, 8, 8, 8], // -
            46: [0, 96, 96, 0, 0], // .
            48: [127, 65, 65, 65, 127], // 0 (Box)
            49: [0, 0, 127, 0, 0],      // 1 (Stick)
            50: [121, 73, 73, 73, 79],  // 2 (Digital 2)
            51: [73, 73, 73, 73, 127],  // 3
            52: [15, 8, 8, 8, 127],     // 4
            53: [79, 73, 73, 73, 121],  // 5
            54: [127, 73, 73, 73, 121], // 6
            55: [1, 1, 1, 1, 127],      // 7
            56: [127, 73, 73, 73, 127], // 8
            57: [79, 73, 73, 73, 127],  // 9
            58: [0, 54, 54, 0, 0],      // :
        };

        //圖標組件
        const Icon = ({ name, className = "w-4 h-4" }) => {
            const icons = {
                trash: <path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6" />,
                lightning: <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />,
                file: <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2zM14 2v6h6M16 13H8M16 17H8M10 9H8" />,
                plus: <path d="M12 5v14M5 12h14" />,
                minus: <path d="M5 12h14" />,
                text: <path d="M4 7V4h16v3M9 20h6M12 4v16" />,
                line: <path d="M5 12h14" />,
                eye: <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8zM12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z" />,
                print: <path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2M6 14h12v8H6v-8z" />,
                play: <path d="M5 3l14 9-14 9V3z" />,
                pause: <g><rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" /></g>,
                monitor: <g><rect x="2" y="3" width="20" height="14" rx="2" ry="2" /><line x1="8" y1="21" x2="16" y2="21" /><line x1="12" y1="17" x2="12" y2="21" /></g>,
                search: <g><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></g>,
                alignLeft: <path d="M4 2v20M8 5h12M8 10h8M8 15h10M8 19h12" />,
                alignCenter: <path d="M12 2v20M5 5h14M8 10h8M6 15h12M4 19h16" />,
                alignRight: <path d="M20 2v20M4 5h12M8 10h12M6 15h14M4 19h12" />,
                alignTop: <path d="M2 4h20M5 20V8M10 16V8M15 22V8M19 18V8" />,
                alignMiddle: <path d="M2 12h20M5 4v5M10 7v2M15 5v4M19 4v5M5 15v5M10 15v2M15 15v4M19 15v5" />,
                alignBottom: <path d="M2 20h20M5 4v12M10 8v8M15 2v14M19 6v14" />,
                code: <path d="m18 16 4-4-4-4M6 8l-4 4 4 4M14.5 4l-5 16" />,
                palette: <g><circle cx="13.5" cy="6.5" r=".5" /><circle cx="17.5" cy="10.5" r=".5" /><circle cx="8.5" cy="7.5" r=".5" /><circle cx="6.5" cy="12.5" r=".5" /><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.9 0 1.6-.5 1.6-1.3 0-.1 0-.2-.1-.4-.4-1.1-.6-2.3-.6-3.5 0-2.5 2-4.5 4.5-4.5h1.6c.8 0 1.4-.7 1.4-1.5.1-4.8-4.1-8.8-8.9-8.8z" /></g>,
                size: <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" />,
                arrowsH: <path d="M21 12H3m0 0l3-3m-3 3l3 3m15-3l-3-3m3 3l-3 3" />,
                arrowsV: <path d="M12 3v18m0-18l-3 3m3-3l3 3m-3 15l-3-3m3 3l3 3" />,
                reverse: <path d="M12 21a9 9 0 1 1 0-18 9 9 0 0 1 0 18zm0-15v12a6 6 0 0 0 0-12z" />,
                download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />,
                open: <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />,
                refresh: <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />,
                alert: <g><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></g>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        // ────────────────────────────────────────────────────────────────────────────────
        // [SECTION 2] LED 模組規格定義
        // ────────────────────────────────────────────────────────────────────────────────
        const LED_SPECS = {
            'P1.25':   { pitch: 1.25, w: 320, h: 160,   pxW: 256, pxH: 128, avgW: 800 },
            'P1.25-L': { pitch: 1.25, w: 600, h: 337.5, pxW: 480, pxH: 270, avgW: 800 },
            
            'P1.5':    { pitch: 1.5,  w: 250, h: 250,   pxW: 167, pxH: 167, avgW: 750 },
            'P1.5-L':  { pitch: 1.5,  w: 600, h: 337.5, pxW: 400, pxH: 225, avgW: 750 },
            
            'P1.56':   { pitch: 1.56, w: 320, h: 160,   pxW: 205, pxH: 102, avgW: 720 },
            
            'P1.86':   { pitch: 1.86, w: 320, h: 160,   pxW: 172, pxH: 86,  avgW: 700 },
            'P1.86-L': { pitch: 1.86, w: 250, h: 250,   pxW: 134, pxH: 134, avgW: 700 }, // 面積較大 (62500 vs 51200)

            'P2':      { pitch: 2.0,  w: 320, h: 160,   pxW: 160, pxH: 80,  avgW: 650 },
            
            'P2.5':    { pitch: 2.5,  w: 320, h: 160,   pxW: 128, pxH: 64,  avgW: 600 },
            
            'P3':      { pitch: 3.0,  w: 192, h: 192,   pxW: 64,  pxH: 64,  avgW: 550 },
            'P3-L':    { pitch: 3.0,  w: 320, h: 160,   pxW: 107, pxH: 53,  avgW: 550 }, // 使用 P3.076 規格
            
            'P4':      { pitch: 4.0,  w: 256, h: 128,   pxW: 64,  pxH: 32,  avgW: 500 },
            'P4-L':    { pitch: 4.0,  w: 320, h: 160,   pxW: 80,  pxH: 40,  avgW: 500 },
            
            'P5':      { pitch: 5.0,  w: 160, h: 160,   pxW: 32,  pxH: 32,  avgW: 450 },
            'P5-L':    { pitch: 5.0,  w: 320, h: 160,   pxW: 64,  pxH: 32,  avgW: 450 },
            
            'P6.67':   { pitch: 6.67, w: 320, h: 320,   pxW: 48,  pxH: 48,  avgW: 400 },
            
            'P8':      { pitch: 8.0,  w: 256, h: 128,   pxW: 32,  pxH: 16,  avgW: 380 },
            'P8-L':    { pitch: 8.0,  w: 320, h: 320,   pxW: 40,  pxH: 40,  avgW: 380 },
            
            'P10':     { pitch: 10.0, w: 320, h: 160,   pxW: 32,  pxH: 16,  avgW: 350 },
        };

        // ════════════════════════════════════════════════════════════════════════════════
        // [SECTION 3] 主應用組件 - App
        // ════════════════════════════════════════════════════════════════════════════════
        
        const App = () => {
            // --- 1. 定義 Refs (頂層定義) ---
            const canvasRef = useRef(null);
            const previewContainerRef = useRef(null);
            const fileInputRef = useRef(null);

            // ───────────────────────────────────────────────────────────────────────────
            // [SECTION 3.1] State 宣告
            // ───────────────────────────────────────────────────────────────────────────
            
            const [modelKey, setModelKey] = useState('P5');
            const [config, setConfig] = useState({ cols: 1, rows: 1 });
            const [voltageAC, setVoltageAC] = useState(220);
            const [voltageDC, setVoltageDC] = useState(5.0); 
            const [zoom, setZoom] = useState(2.0);
            const [showDividers, setShowDividers] = useState(true);
            const [showBOM, setShowBOM] = useState(false);
            const [showCodeExport, setShowCodeExport] = useState(false); 
            const [showConfig, setShowConfig] = useState(false); 
            const [isAnimActive, setIsAnimActive] = useState(false);
            const [isConfigCollapsed, setIsConfigCollapsed] = useState(false); 
            const [parseError, setParseError] = useState("");
            const [exportCode, setExportCode] = useState('');
            const [customFileName, setCustomFileName] = useState('led_design_v1.ino');
            
            // 亮度控制
            const [gridBrightness, setGridBrightness] = useState(0.3);

            // 核心物件狀態
            // 注意：新增 font 屬性，預設為 'matrix'
            const [items, setItems] = useState([
                { id: 1, type: 'text', x: 1, y: 4, color: '#ff0000', content: '88', size: 3, font: 'digital', animation: 'none', isCollapsed: false, isReversed: false },
                { id: 2, type: 'text', x: 34, y: 4, color: '#1eff00', content: '88', size: 3, font: 'matrix', animation: 'none', isCollapsed: false, isReversed: false },
                { id: 3, type: 'line', x: 31, y: 1, len: 30, thick: 1, dir: 'V', color: '#ffffff', animation: 'none', isCollapsed: false, isReversed: false }
            ]);

            const [selectedIds, setSelectedIds] = useState([]);
            const [dragStart, setDragStart] = useState(null);
            const [isDragging, setIsDragging] = useState(false);
            const [selectionRect, setSelectionRect] = useState(null);
            const [isBoxSelecting, setIsBoxSelecting] = useState(false);

            // --- 新增: Undo/Copy/Paste 相關狀態 ---
            const [history, setHistory] = useState([]); // 歷史紀錄堆疊
            const [clipboard, setClipboard] = useState([]); // 剪貼簿

            const spec = LED_SPECS[modelKey] || LED_SPECS['P5'];

            // ───────────────────────────────────────────────────────────────────────────
            // [SECTION 3.2] 計算邏輯
            // ───────────────────────────────────────────────────────────────────────────
            
            const stats = useMemo(() => {
                const totalPxW = spec.pxW * config.cols;
                const totalPxH = spec.pxH * config.rows;
                const moduleCount = config.cols * config.rows;
                const mmW = spec.w * config.cols;
                const mmH = spec.h * config.rows;
                const areaM2 = (mmW * mmH) / 1000000;
                const avgPower = Math.round(areaM2 * spec.avgW);
                const peakPower = Math.round(avgPower * 1.6);
                const currentAC = (peakPower / voltageAC).toFixed(2);
                const vDC = parseFloat(voltageDC) || 5.0;
                const currentDC = (peakPower / vDC).toFixed(1); 
                const receiverCount = Math.ceil((totalPxW * totalPxH) / 65536);
                const psuCount = Math.ceil(peakPower / 180);
                return { totalPxW, totalPxH, moduleCount, mmW, mmH, areaM2, avgPower, peakPower, currentAC, currentDC, receiverCount, psuCount };
            }, [modelKey, config, voltageAC, voltageDC]);

            // ───────────────────────────────────────────────────────────────────────────
            // [SECTION 3.3] 元件操作與邏輯
            // ───────────────────────────────────────────────────────────────────────────

            // 輔助函式: 儲存當前狀態到歷史紀錄
            const saveHistory = () => {
                setHistory(prev => {
                    const newHistory = [...prev, items];
                    // 限制歷史紀錄長度為 10 步
                    if (newHistory.length > 10) newHistory.shift();
                    return newHistory;
                });
            };

            const updateItem = (id, field, val) => {
                setItems(prev => prev.map(i => i.id === id ? { ...i, [field]: val } : i));
            };

            const toggleCollapse = (id) => {
                setItems(prev => prev.map(i => i.id === id ? { ...i, isCollapsed: !i.isCollapsed } : i));
            };

            const getItemBounds = (item) => {
                let width = 0, height = 0;
                const currentSize = parseFloat(item.size) || 1;
                if (item.type === 'text') {
                    // 修正：依據字庫邏輯 (5寬 + 1距) = 6
                    width = item.content.length * 6 * currentSize;
                    height = 8 * currentSize;
                } else if (item.type === 'line') {
                    width = item.dir === 'H' ? item.len : item.thick;
                    height = item.dir === 'V' ? item.len : item.thick;
                }
                return { x1: item.x, y1: item.y, x2: item.x + width, y2: item.y + height };
            };

            const generateControllerCode = () => {
                let code = `/* \n * LED Studio Pro - Generated ESP32 Code\n * Spec: ${modelKey} (${stats.totalPxW}x${stats.totalPxH} px)\n */\n\nvoid drawUI() {\n`;
                items.forEach((item, index) => {
                    const colorHex = item.color.replace('#', '0X').toUpperCase();
                    code += `  // Item #${index + 1}: ${item.type.toUpperCase()}\n`;
                    if (item.type === 'text') {
                        code += `  dma_display->setTextSize(${item.size});\n`;
                        code += `  dma_display->setCursor(${item.x}, ${item.y});\n`;
                        if (item.isReversed) code += `  dma_display->setTextColor(0x0000, ${colorHex});\n`;
                        else code += `  dma_display->setTextColor(${colorHex});\n`;
                        code += `  dma_display->print("${item.content}");\n`;
                    } else {
                        const x2 = item.dir === 'H' ? item.x + item.len : item.x;
                        const y2 = item.dir === 'V' ? item.y + item.len : item.y;
                        code += `  dma_display->drawLine(${item.x}, ${item.y}, ${x2}, ${y2}, ${colorHex});\n`;
                    }
                    code += `\n`;
                });
                code += `}\n`;
                return code;
            };

            const parseAndReadCode = (code) => {
                setParseError("");
                const newItems = [];
                const specMatch = code.match(/Spec:\s+([A-Z0-9.-]+L?)\s+\((\d+)x(\d+)\s+px\)/i);
                if (specMatch) {
                    const mKey = specMatch[1];
                    if (LED_SPECS[mKey]) {
                        setModelKey(mKey);
                        const totalW = parseInt(specMatch[2]), totalH = parseInt(specMatch[3]);
                        setConfig({
                            cols: Math.max(1, Math.round(totalW / LED_SPECS[mKey].pxW)),
                            rows: Math.max(1, Math.round(totalH / LED_SPECS[mKey].pxH))
                        });
                    }
                }
                const textRegex = /setTextSize\((\d+\.?\d*)\);\s+dma_display->setCursor\((\d+),\s+(\d+)\);\s+(?:dma_display->setTextColor\(0x0000,\s+([0-9A-Za-fxX]+)\);|dma_display->setTextColor\(([0-9A-Za-fxX]+)\);)\s+dma_display->print\("(.*?)"\);/gsi;
                let match;
                while ((match = textRegex.exec(code)) !== null) {
                    const isReversed = !!match[4];
                    const rawColor = isReversed ? match[4] : match[5];
                    const hexColor = rawColor.replace(/0x/i, '#').padEnd(7, '0').toLowerCase();
                    // 新增 font: 'matrix' 預設
                    newItems.push({ id: Date.now() + Math.random(), type: 'text', size: parseFloat(match[1]), x: parseInt(match[2]), y: parseInt(match[3]), color: hexColor, isReversed, content: match[6], font: 'matrix', animation: 'none', isCollapsed: false });
                }
                const lineRegex = /drawLine\((\d+),\s+(\d+),\s+(\d+),\s+(\d+),\s+([0-9A-Za-fxX]+)\);/gi;
                while ((match = lineRegex.exec(code)) !== null) {
                    const x1 = parseInt(match[1]), y1 = parseInt(match[2]), x2 = parseInt(match[3]), y2 = parseInt(match[4]);
                    const hexColor = match[5].replace(/0x/i, '#').padEnd(7, '0').toLowerCase();
                    const dir = x1 === x2 ? 'V' : 'H', len = dir === 'H' ? Math.abs(x2 - x1) : Math.abs(y2 - y1);
                    newItems.push({ id: Date.now() + Math.random(), type: 'line', x: x1, y: y1, len, thick: 1, dir, color: hexColor, animation: 'none', isCollapsed: false, isReversed: false });
                }
                if (newItems.length > 0) { setItems(newItems); return true; }
                setParseError("識別失敗：代碼中無可用指令。"); return false;
            };

            const downloadCodeFile = () => {
                const blob = new Blob([exportCode], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const fileName = customFileName.trim() || 'led_design';
                a.download = fileName.endsWith('.ino') ? fileName : `${fileName}.ino`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleFileLoad = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => setExportCode(event.target.result);
                reader.readAsText(file);
                e.target.value = null;
            };

            // --- 5. 畫布互動 ---
            const handleCanvasMouseDown = (e) => {
                if (e.button !== 0) return;
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.tagName === 'SELECT') return;

                const rect = previewContainerRef.current.getBoundingClientRect();
                
                if (canvasRef.current) {
                    const canvasRect = canvasRef.current.getBoundingClientRect();
                    const cX = (e.clientX - canvasRect.left) / zoom;
                    const cY = (e.clientY - canvasRect.top) / zoom;
                    
                    if (!e.shiftKey) setSelectedIds([]);
                    setIsBoxSelecting(true);
                    setSelectionRect({ x1: cX, y1: cY, x2: cX, y2: cY });
                }
            };

            const handleItemMouseDown = (e, id) => {
                e.stopPropagation();
                // 在開始拖曳前，先存檔 (Undo 準備)
                if (!e.shiftKey) saveHistory(); 

                if (e.shiftKey) setSelectedIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
                else {
                    if (!selectedIds.includes(id)) setSelectedIds([id]);
                    setDragStart({ x: e.clientX, y: e.clientY });
                    setIsDragging(true);
                }
            };

            const handleMouseMove = (e) => {
                if (isDragging && dragStart) {
                    const dx = (e.clientX - dragStart.x) / zoom, dy = (e.clientY - dragStart.y) / zoom;
                    setItems(prev => prev.map(item => selectedIds.includes(item.id) ? { ...item, x: Math.round(item.x + dx), y: Math.round(item.y + dy) } : item));
                    setDragStart({ x: e.clientX, y: e.clientY });
                }
                if (isBoxSelecting && selectionRect && canvasRef.current) {
                    const canvasRect = canvasRef.current.getBoundingClientRect();
                    const curX = (e.clientX - canvasRect.left) / zoom, curY = (e.clientY - canvasRect.top) / zoom;
                    const newRect = { ...selectionRect, x2: curX, y2: curY };
                    setSelectionRect(newRect);
                    const xMin = Math.min(newRect.x1, newRect.x2), xMax = Math.max(newRect.x1, newRect.x2), yMin = Math.min(newRect.y1, newRect.y2), yMax = Math.max(newRect.y1, newRect.y2);
                    const hitIds = items.filter(item => { const b = getItemBounds(item); return !(b.x2 < xMin || b.x1 > xMax || b.y2 < yMin || b.y1 > yMax); }).map(i => i.id);
                    if (e.shiftKey) setSelectedIds(prev => Array.from(new Set([...prev, ...hitIds])));
                    else setSelectedIds(hitIds);
                }
            };

            const handleMouseUp = () => { setIsDragging(false); setDragStart(null); setIsBoxSelecting(false); setSelectionRect(null); };

            // ───────────────────────────────────────────────────────────────────────────
            // [SECTION 3.5] Effects - 渲染引擎 & 快捷鍵
            // ───────────────────────────────────────────────────────────────────────────

            // --- LED 擬真渲染引擎 ---
            useEffect(() => {
                const canvas = canvasRef.current; 
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                const width = stats.totalPxW;
                const height = stats.totalPxH;

                canvas.width = width * zoom;
                canvas.height = height * zoom;

                const buffer = document.createElement('canvas');
                buffer.width = width;
                buffer.height = height;
                const bCtx = buffer.getContext('2d');
                bCtx.imageSmoothingEnabled = false;

                items.forEach(item => {
                    bCtx.fillStyle = item.color;
                    if (item.type === 'text') {
                        // 確保 scale 是整數，避免運算誤差
                        const scale = Math.max(1, Math.floor(item.size || 1));
                        
                        // [修正] 智慧置中偏移量計算
                        // 只有當尺寸 >= 2 時，我們才能有效地在整數網格上做置中 (例如 10px 在 12px 空間)
                        // Size 1 (5px in 6px) 無法整數置中，維持靠左
                        const offsetX = scale > 1 ? Math.floor(scale / 2) : 0;
                        const offsetY = scale > 1 ? Math.floor(scale / 2) : 0;

                        if (item.font === 'digital') {
                            const str = item.content.toUpperCase();
                            let cx = item.x;
                            const cy = item.y;

                            if (item.isReversed) {
                                bCtx.fillStyle = item.color;
                                bCtx.fillRect(cx, cy, str.length * 6 * scale, 8 * scale);
                                bCtx.fillStyle = '#000000';
                            }

                            for (let i = 0; i < str.length; i++) {
                                const charCode = str.charCodeAt(i);
                                const charData = FONT_DIGITAL[charCode] || FONT_5X7[charCode] || FONT_5X7[32];
                                
                                for (let col = 0; col < 5; col++) {
                                    const line = charData[col];
                                    for (let row = 0; row < 7; row++) {
                                        if (line & (1 << row)) {
                                            // [應用偏移] 加上 offsetX/Y 讓文字居中
                                            bCtx.fillRect(
                                                cx + (col * scale) + offsetX, 
                                                cy + (row * scale) + offsetY, 
                                                scale, 
                                                scale
                                            );
                                        }
                                    }
                                }
                                cx += 6 * scale;
                            }

                        } else {
                            // Matrix Font
                            const fontSize = scale * 8;
                            bCtx.font = `900 ${fontSize}px "JetBrains Mono", monospace`; 
                            bCtx.textBaseline = 'top';
                            
                            // 針對 Canvas 文字 API 的微調
                            // 這裡我們稍微調整繪製座標來模擬置中
                            const renderX = item.x + (scale > 1 ? scale * 0.5 : 0);
                            const renderY = item.y + (scale > 1 ? scale * 0.2 : 0); // 字型基線微調

                            if (item.isReversed) {
                                const metrics = bCtx.measureText(item.content);
                                bCtx.fillStyle = item.color;
                                bCtx.fillRect(item.x, item.y, metrics.width, fontSize);
                                bCtx.fillStyle = '#000000';
                            }
                            bCtx.fillText(item.content, renderX, renderY); 
                        }
                    } else if (item.type === 'line') {
                        const w = item.dir === 'H' ? item.len : item.thick;
                        const h = item.dir === 'V' ? item.len : item.thick;
                        bCtx.fillRect(item.x, item.y, w, h);
                    }
                });

                const imgData = bCtx.getImageData(0, 0, width, height).data;
                
                ctx.fillStyle = '#000000'; 
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                const radius = zoom * 0.4; 
                const offset = zoom / 2;

                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const idx = (y * width + x) * 4;
                        const r = imgData[idx];
                        const g = imgData[idx+1];
                        const b = imgData[idx+2];
                        const isLit = imgData[idx+3] > 100;

                        const cx = x * zoom + offset;
                        const cy = y * zoom + offset;

                        if (isLit) {
                            const color = `rgb(${r},${g},${b})`;
                            ctx.beginPath();
                            ctx.arc(cx, cy, radius, 0, Math.PI * 2);
                            ctx.fillStyle = color;
                            ctx.shadowColor = color;
                            ctx.shadowBlur = zoom * 0.6; 
                            ctx.fill();
                            ctx.shadowBlur = 0; 
                            ctx.fillStyle = 'rgba(255,255,255,0.7)';
                            ctx.beginPath();
                            ctx.arc(cx, cy, radius * 0.35, 0, Math.PI * 2);
                            ctx.fill();
                        } else {
                            ctx.beginPath();
                            ctx.arc(cx, cy, radius, 0, Math.PI * 2);
                            ctx.fillStyle = '#222'; 
                            ctx.fill();
                        }
                    }
                }

                if (showDividers) {
                    ctx.strokeStyle = '#3b82f6';
                    ctx.lineWidth = 1;
                    ctx.globalAlpha = 0.3; 
                    for (let x = spec.pxW; x < width; x += spec.pxW) {
                        ctx.beginPath(); ctx.moveTo(x * zoom, 0); ctx.lineTo(x * zoom, canvas.height); ctx.stroke();
                    }
                    for (let y = spec.pxH; y < height; y += spec.pxH) {
                        ctx.beginPath(); ctx.moveTo(0, y * zoom); ctx.lineTo(canvas.width, y * zoom); ctx.stroke();
                    }
                    ctx.globalAlpha = 1.0;
                }

            }, [items, stats, zoom, showDividers]);

            // --- 快捷鍵事件監聽 (Del, Undo, Copy, Paste, Arrows) ---
            useEffect(() => {
                const handleKeyDown = (e) => {
                    const activeEl = document.activeElement;
                    if (activeEl.tagName === 'INPUT' || activeEl.tagName === 'SELECT' || activeEl.tagName === 'TEXTAREA') return;

                    // 1. Delete / Backspace: 刪除物件
                    if (e.key === 'Delete' || e.key === 'Backspace') {
                        if (selectedIds.length > 0) {
                            e.preventDefault();
                            saveHistory(); // 存檔
                            setItems(prev => prev.filter(i => !selectedIds.includes(i.id)));
                            setSelectedIds([]); // 清空選取
                        }
                    }

                    // 2. Ctrl+Z (Mac: Cmd+Z): Undo 復原
                    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') {
                        e.preventDefault();
                        setHistory(prev => {
                            if (prev.length === 0) return prev;
                            const previousItems = prev[prev.length - 1]; // 取得上一步
                            const newHistory = prev.slice(0, -1); // 移除最後一步
                            setItems(previousItems); // 還原 items
                            return newHistory;
                        });
                    }

                    // 3. Ctrl+C (Mac: Cmd+C): 複製
                    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'c') {
                        if (selectedIds.length > 0) {
                            e.preventDefault();
                            // 將當前選取的物件深拷貝到剪貼簿
                            const selectedItems = items.filter(i => selectedIds.includes(i.id));
                            setClipboard(JSON.parse(JSON.stringify(selectedItems)));
                        }
                    }

                    // 4. Ctrl+V (Mac: Cmd+V): 貼上
                    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'v') {
                        if (clipboard.length > 0) {
                            e.preventDefault();
                            saveHistory(); // 存檔

                            // 產生新物件 (賦予新 ID 並稍微偏移位置)
                            const newItems = clipboard.map(item => ({
                                ...item,
                                id: Date.now() + Math.random(), // 確保 ID 唯一
                                x: item.x + 2, // 偏移 2px 讓使用者知道是新貼上的
                                y: item.y + 2
                            }));

                            setItems(prev => [...prev, ...newItems]);
                            setSelectedIds(newItems.map(i => i.id)); // 自動選取新貼上的物件
                        }
                    }

                    // 5. 方向鍵移動
                    if (selectedIds.length > 0 && ['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
                        let dx = 0, dy = 0; 
                        const step = e.shiftKey ? 10 : 1;
                        switch (e.key) {
                            case 'ArrowLeft': dx = -step; break;
                            case 'ArrowRight': dx = step; break;
                            case 'ArrowUp': dy = -step; break;
                            case 'ArrowDown': dy = step; break;
                            default: return;
                        }
                        e.preventDefault();
                        setItems(prev => prev.map(item => selectedIds.includes(item.id) ? { ...item, x: item.x + dx, y: item.y + dy } : item));
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [selectedIds, items, clipboard, history]);

            useEffect(() => {
                const handleWheel = (e) => {
                    if (previewContainerRef.current?.contains(e.target)) {
                        e.preventDefault();
                        
                        setZoom(prev => {
                            const isZoomIn = e.deltaY < 0;
                            let newZoom = prev;

                            if (isZoomIn) {
                                // 放大
                                if (prev < 1.0) {
                                    newZoom = prev + 0.1;
                                } else {
                                    // 大於等於 1 時，每次 +1
                                    newZoom = Math.floor(prev) + 1.0; 
                                }
                            } else {
                                // 縮小
                                if (prev > 1.0) {
                                    // 大於 1 時，每次 -1
                                    newZoom = Math.ceil(prev) - 1.0;
                                    // 如果減過頭變成了 0 (例如 1.0 - 1)，修正為 0.9 以便銜接小數區間
                                    if (newZoom < 1.0) newZoom = 1.0; 
                                    // 特殊處理：如果原本就是 1.0，要變成 0.9
                                    if (prev === 1.0) newZoom = 0.9;
                                } else {
                                    newZoom = prev - 0.1;
                                }
                            }

                            // 修正浮點數精度 (例如 0.1 + 0.2 = 0.300000004)
                            newZoom = parseFloat(newZoom.toFixed(1));
                            
                            // 限制範圍
                            return Math.min(Math.max(newZoom, 0.1), 20.0);
                        });
                    }
                };
                const container = previewContainerRef.current;
                if (container) container.addEventListener('wheel', handleWheel, { passive: false });
                return () => { if (container) container.removeEventListener('wheel', handleWheel); };
            }, []);

            useEffect(() => {
                if (showCodeExport) setExportCode(generateControllerCode());
            }, [showCodeExport, items, modelKey, config]);

            const addItem = (type) => {
                const base = { id: Date.now() + Math.random(), type, x: 1, y: 1, color: '#ffffff', animation: 'none', isCollapsed: false, isReversed: false };
                if (type === 'text') setItems(prev => [...prev, { ...base, content: 'NEW', size: 2, font: 'matrix' }]);
                else setItems(prev => [...prev, { ...base, len: 32, thick: 1, dir: 'H' }]);
            };

            // 對齊邏輯
            const alignSelected = (axis, mode) => {
                if (selectedIds.length < 2) return;
                const sel = items.filter(i => selectedIds.includes(i.id));
                const bounds = sel.map(getItemBounds);

                if (axis === 'x') {
                    if (mode === 'left') {
                        const minX = Math.min(...sel.map(i => i.x)); 
                        setItems(prev => prev.map(i => selectedIds.includes(i.id) ? { ...i, x: minX } : i));
                    } 
                    else if (mode === 'right') {
                        const maxRight = Math.max(...bounds.map(b => b.x2));
                        setItems(prev => prev.map(i => {
                            if (!selectedIds.includes(i.id)) return i;
                            const b = getItemBounds(i);
                            const width = b.x2 - b.x1;
                            return { ...i, x: maxRight - width };
                        }));
                    } 
                    else if (mode === 'center') {
                        const minX = Math.min(...bounds.map(b => b.x1));
                        const maxX = Math.max(...bounds.map(b => b.x2));
                        const mid = Math.round((minX + maxX) / 2);
                        setItems(prev => prev.map(i => {
                            if (!selectedIds.includes(i.id)) return i;
                            const b = getItemBounds(i);
                            const width = b.x2 - b.x1;
                            return { ...i, x: Math.round(mid - width / 2) };
                        }));
                    }
                } 
                else if (axis === 'y') {
                    if (mode === 'top') {
                        const minY = Math.min(...sel.map(i => i.y));
                        setItems(prev => prev.map(i => selectedIds.includes(i.id) ? { ...i, y: minY } : i));
                    } 
                    else if (mode === 'bottom') {
                        const maxBottom = Math.max(...bounds.map(b => b.y2));
                        setItems(prev => prev.map(i => {
                            if (!selectedIds.includes(i.id)) return i;
                            const b = getItemBounds(i);
                            const height = b.y2 - b.y1;
                            return { ...i, y: maxBottom - height };
                        }));
                    } 
                    else if (mode === 'middle') {
                        const minY = Math.min(...bounds.map(b => b.y1));
                        const maxY = Math.max(...bounds.map(b => b.y2));
                        const mid = Math.round((minY + maxY) / 2);
                        setItems(prev => prev.map(i => {
                            if (!selectedIds.includes(i.id)) return i;
                            const b = getItemBounds(i);
                            const height = b.y2 - b.y1;
                            return { ...i, y: Math.round(mid - height / 2) };
                        }));
                    }
                }
            };

            const copyToClipboard = (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text; document.body.appendChild(textArea); textArea.select();
                document.execCommand('copy'); document.body.removeChild(textArea);
            };

            // ───────────────────────────────────────────────────────────────────────────
            // [SECTION 3.6] Render UI
            // ───────────────────────────────────────────────────────────────────────────

            return (
                <div className="flex h-screen w-full overflow-hidden select-none" onMouseMove={handleMouseMove} onMouseUp={handleMouseUp}>
                    {/* 左側：主畫布區域 */}
                    <div className="flex-1 flex flex-col bg-black relative border-r border-white/5">
                        <nav className="p-4 bg-slate-900/95 border-b border-white/5 flex justify-between items-center z-50 shadow-2xl">
                            <div className="flex gap-6 items-center">
                                <header className="hidden md:block pr-6 border-r border-white/10">
                                    <h1 className="flex items-end tracking-tight">
                                        <div className="led-dot-matrix text-5xl flex gap-1 mr-6">
                                            <span style={{ color: '#ef4444' }}>L</span><span style={{ color: '#22c55e' }}>E</span><span style={{ color: '#3b82f6' }}>D</span>
                                        </div>
                                        <span className="text-xl font-black text-slate-400 uppercase italic pb-1">STUDIO PRO</span>
                                    </h1>
                                </header>
                                <div className="flex items-center gap-4">
                                    <button onClick={()=>setShowDividers(!showDividers)} className={`p-2 rounded-lg border transition-all ${showDividers ? 'bg-blue-500/20 border-blue-500 text-blue-400' : 'bg-slate-800 border-white/5 text-slate-500'}`}><Icon name="eye" /></button>
                                    <button onClick={()=>setShowConfig(true)} className="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-white/10 text-yellow-400 shadow-lg"><Icon name="lightning" className="w-5 h-5" /></button>
                                    <button onClick={()=>setIsAnimActive(!isAnimActive)} className={`p-2 rounded-lg border transition-all shadow-lg ${isAnimActive ? 'bg-emerald-600/20 border-emerald-500 text-emerald-400' : 'bg-slate-800 border-white/10 text-slate-500'}`}><Icon name={isAnimActive ? "pause" : "play"} /></button>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={()=>setShowCodeExport(true)} className="bg-slate-800 hover:bg-slate-700 border border-white/10 text-blue-400 p-2 rounded-lg shadow-lg active:scale-95 transition-all flex items-center justify-center"><Icon name="code" className="w-5 h-5" /></button>
                                <button onClick={()=>setShowBOM(true)} className="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg text-xs font-black flex items-center gap-2 transition-all shadow-lg shadow-blue-500/20 uppercase tracking-widest"><Icon name="file" /><span>BOM</span></button>
                            </div>
                        </nav>

                        {/* --- 預覽區核心 (混合 Canvas + Div) --- */}
                        <div ref={previewContainerRef} onMouseDown={handleCanvasMouseDown} className="flex-1 overflow-auto flex items-center justify-center p-24 bg-[radial-gradient(#111827_1px,transparent_1px)] [background-size:24px_24px] cursor-crosshair relative text-white">
                            
                            {/* 容器：設定陰影和大小 */}
                            <div className="relative bg-black shadow-[0_30px_60px_rgba(0,0,0,0.8)]" style={{ width: stats.totalPxW * zoom, height: stats.totalPxH * zoom }}>
                                
                                {/* Layer 1: LED 擬真顯示層 (Canvas) - 放在最底層，純視覺 */}
                                <canvas 
                                    ref={canvasRef} 
                                    className="absolute inset-0 block pixelated pointer-events-none"
                                    style={{ width: '100%', height: '100%' }}
                                />
                                
                                {/* Layer 2: 互動控制層 (Invisible Interactive Layer) */}
                                <div className="w-full h-full relative z-10">
                                    {items.map(item => {
                                        const isSelected = selectedIds.includes(item.id);
                                        const currentSize = Math.floor(parseFloat(item.size) || 1); // 強制整數
                                        
                                        // [修正] 虛線框尺寸計算
                                        // 確保與 Canvas 繪製邏輯 (6寬8高) 完全一致
                                        const width = (item.type === 'text' ? item.content.length * 6 * currentSize : (item.dir==='H' ? item.len : item.thick)) * zoom;
                                        const height = (item.type === 'text' ? 8 * currentSize : (item.dir==='V' ? item.len : item.thick)) * zoom;

                                        return (
                                            <div 
                                                key={item.id} 
                                                onMouseDown={(e) => handleItemMouseDown(e, item.id)} 
                                                className="absolute cursor-move"
                                                style={{ 
                                                    left: item.x * zoom, 
                                                    top: item.y * zoom,
                                                    width: width,
                                                    height: height,
                                                    // [修正] 加大 outlineOffset 讓虛線框包在燈珠光暈之外
                                                    outline: isSelected ? `2px dashed #60a5fa` : 'none', 
                                                    outlineOffset: '4px', 
                                                    zIndex: isSelected ? 50 : 20,
                                                }}
                                            />
                                        );
                                    })}
                                </div>

                                {/* Layer 3: 滑鼠框選範圍顯示 */}
                                {isBoxSelecting && selectionRect && (
                                    <div className="absolute border border-purple-500 border-dashed bg-purple-500/20 pointer-events-none z-50" style={{ left: Math.min(selectionRect.x1, selectionRect.x2) * zoom, top: Math.min(selectionRect.y1, selectionRect.y2) * zoom, width: Math.abs(selectionRect.x2 - selectionRect.x1) * zoom, height: Math.abs(selectionRect.y2 - selectionRect.y1) * zoom }} />
                                )}
                            </div>
                        </div>

                        <footer className="px-6 py-4 bg-slate-900/90 backdrop-blur-md border-t border-white/5 flex justify-between items-center text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em]">
                            <div className="flex gap-10 items-center">
                                <span>Res: <span className="text-slate-300 font-black">{stats.totalPxW}x{stats.totalPxH} px</span></span>
                                <span>Dim: <span className="text-slate-300 font-black">{stats.mmW}x{stats.mmH} mm</span></span>
                                <div className="flex items-center gap-3 border-l border-white/10 pl-6 ml-2">
                                    <Icon name="search" className="w-4 h-4 text-slate-400" />
                                    <input type="range" min="0.1" max="10" step="0.1" value={zoom} onChange={e=>setZoom(parseFloat(e.target.value))} className="w-32 h-1 accent-blue-500 bg-slate-800 rounded-full appearance-none cursor-pointer" />
                                    <span className="text-[10px] font-black text-blue-400 w-8 text-right">{zoom.toFixed(1)}x</span>
                                </div>
                            </div>
                            <span>Area: <span className="text-blue-400 font-black">{stats.areaM2.toFixed(3)} m²</span></span>
                        </footer>
                    </div>

                    {/* 右側：控制面板 */}
                    <div className="w-80 bg-slate-900/40 flex flex-col p-4 space-y-3 overflow-y-auto custom-scrollbar">
                        <section className="space-y-3 pb-4 border-b border-white/10">
                            <div className="flex justify-between items-center">
                                <h3 className="text-sm font-black text-blue-400 uppercase tracking-widest flex items-center gap-2"><Icon name="monitor" className="w-4 h-4" /> 螢幕配置</h3>
                                <button onClick={()=>setIsConfigCollapsed(!isConfigCollapsed)} className="p-1.5 hover:bg-blue-500/10 text-slate-600 hover:text-blue-400 rounded-lg transition-all"><Icon name={isConfigCollapsed ? "plus" : "minus"} /></button>
                            </div>
                            {!isConfigCollapsed && (
                                <div className="space-y-3 animate-in fade-in slide-in-from-top-2">
                                    <div className="space-y-1">
                                        <label className="text-xs text-slate-400 uppercase font-black block">模組型號</label>
                                        <select className="w-full bg-slate-950 p-3 rounded-xl border border-white/10 text-xs text-white outline-none appearance-none font-bold" value={modelKey} onChange={e=>setModelKey(e.target.value)}>
                                            {Object.keys(LED_SPECS).map(k=><option key={k} value={k}>{k} ({LED_SPECS[k].w}x{LED_SPECS[k].h} mm)</option>)}
                                        </select>
                                    </div>
                                    <div className="flex items-center gap-6">
                                        <div className="flex items-center gap-3"><span className="text-xl font-black text-blue-500 italic leading-none">W</span><input type="number" className="w-16 bg-slate-950 p-3 rounded-xl text-xs border border-white/10 text-white font-black text-center" value={config.cols} onChange={e=>setConfig({...config, cols:parseInt(e.target.value)||1})} /></div>
                                        <div className="flex items-center gap-3"><span className="text-xl font-black text-blue-500 italic leading-none">H</span><input type="number" className="w-16 bg-slate-950 p-3 rounded-xl text-xs border border-white/10 text-white font-black text-center" value={config.rows} onChange={e=>setConfig({...config, rows:parseInt(e.target.value)||1})} /></div>
                                    </div>
                                </div>
                            )}
                        </section>

                        <header className="flex justify-between items-center border-b border-white/5 pb-2">
                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest font-bold">元件編輯</h3>
                            <div className="flex gap-2 items-center">
                                <div className="flex gap-2">
                                    <button onClick={()=>addItem('text')} className="p-2 bg-slate-800 hover:bg-blue-600/40 rounded-lg border border-white/10 text-blue-400"><Icon name="text" /></button>
                                    <button onClick={()=>addItem('line')} className="p-2 bg-slate-800 hover:bg-emerald-600/40 rounded-lg border border-white/10 text-emerald-400"><Icon name="line" /></button>
                                </div>
                                {/* 補回對齊按鈕群組 - 只在選取多個物件時顯示 */}
                                {selectedIds.length > 1 && (
                                    <div className="flex items-center gap-1 pl-2 border-l border-white/5 animate-in fade-in slide-in-from-right-2">
                                        <button title="水平置左" onClick={() => alignSelected('x','left')} className="p-1.5 rounded bg-slate-800 border border-white/10 text-slate-300 hover:text-white"><Icon name="alignLeft" className="w-3 h-3" /></button>
                                        <button title="水平置中" onClick={() => alignSelected('x','center')} className="p-1.5 rounded bg-slate-800 border border-white/10 text-slate-300 hover:text-white"><Icon name="alignCenter" className="w-3 h-3" /></button>
                                        <button title="水平置右" onClick={() => alignSelected('x','right')} className="p-1.5 rounded bg-slate-800 border border-white/10 text-slate-300 hover:text-white"><Icon name="alignRight" className="w-3 h-3" /></button>
                                        <div className="w-px h-4 bg-white/5 mx-1" />
                                        <button title="垂直置上" onClick={() => alignSelected('y','top')} className="p-1.5 rounded bg-slate-800 border border-white/10 text-slate-300 hover:text-white"><Icon name="alignTop" className="w-3 h-3" /></button>
                                        <button title="垂直置中" onClick={() => alignSelected('y','middle')} className="p-1.5 rounded bg-slate-800 border border-white/10 text-slate-300 hover:text-white"><Icon name="alignMiddle" className="w-3 h-3" /></button>
                                        <button title="垂直置下" onClick={() => alignSelected('y','bottom')} className="p-1.5 rounded bg-slate-800 border border-white/10 text-slate-300 hover:text-white"><Icon name="alignBottom" className="w-3 h-3" /></button>
                                    </div>
                                )}
                            </div>
                        </header>

                        <div className="space-y-2 pb-6">
                            {items.map((item, idx) => (
                                <div key={item.id} onClick={() => setSelectedIds([item.id])} className={`bg-slate-950 p-2.5 rounded-xl border space-y-2 shadow-2xl transition-all ${selectedIds.includes(item.id) ? 'border-blue-500 shadow-blue-500/10' : 'border-white/5 hover:border-blue-500/30'}`}>
                                    <div className="flex justify-between items-center border-b border-white/10 pb-1.5"><div className="flex items-center gap-2 flex-1"><span className={`w-6 h-6 flex-shrink-0 flex items-center justify-center rounded-lg text-xs font-black ${selectedIds.includes(item.id) ? 'bg-blue-500 text-white' : 'bg-blue-500/10 text-blue-400'}`}>{idx+1}</span>{item.type === 'text' ? <input className="bg-transparent border-b border-transparent hover:border-white/10 focus:border-blue-500 outline-none text-xs font-bold text-white px-1 flex-1 transition-all" value={item.content} onChange={e=>updateItem(item.id, 'content', e.target.value)} onClick={(e)=>e.stopPropagation()}/> : <span className="text-xs font-black text-slate-400 uppercase italic text-[10px]">線條元件</span>}</div><div className="flex gap-1 flex-shrink-0"><button onClick={(e)=>{e.stopPropagation(); toggleCollapse(item.id)}} className="p-1.5 hover:bg-blue-500/10 transition-all text-slate-500 hover:text-white"><Icon name={item.isCollapsed ? "plus" : "minus"} /></button><button onClick={(e)=>{e.stopPropagation(); setItems(prev => prev.filter(i=>i.id!==item.id))}} className="p-1.5 hover:bg-red-500/10 transition-all text-slate-500 hover:text-red-500"><Icon name="trash" /></button></div></div>
                                    {!item.isCollapsed && (
                                        <div className="space-y-2 pt-1 animate-in fade-in">
                                            <div className="flex items-center gap-2">
                                                <div title="動畫設置" className="p-1.5 bg-slate-900 rounded-lg text-slate-500"><Icon name="play" className="w-3.5 h-3.5" /></div>
                                                <select className="flex-1 bg-slate-900 text-xs p-1.5 rounded-lg border border-white/5 text-slate-300 outline-none" value={item.animation} onChange={e => updateItem(item.id, 'animation', e.target.value)}><option value="none">靜態</option><option value="blink">閃爍</option><option value="breath">呼吸</option><option value="scroll">平移</option></select>
                                                <button onClick={(e) => { e.stopPropagation(); updateItem(item.id, 'isReversed', !item.isReversed); }} className={`p-1.5 rounded-lg border transition-all ${item.isReversed ? 'bg-blue-500/20 border-blue-500 text-blue-400' : 'bg-slate-900 border-white/5 text-slate-500'}`} title="反白模式"><Icon name="reverse" className="w-3.5 h-3.5" /></button>
                                            </div>
                                            
                                            {/* 字型選擇 (僅文字物件顯示) */}
                                            {item.type === 'text' && (
                                                <div className="flex items-center gap-2 bg-slate-900/50 p-1 rounded-lg border border-white/5 mb-2">
                                                    <div title="字型" className="text-slate-500 pl-1"><Icon name="text" className="w-3.5 h-3.5" /></div>
                                                    <select className="bg-slate-950 text-[10px] text-white p-1 rounded border border-white/5 outline-none flex-1 font-bold" value={item.font || 'matrix'} onChange={e=>updateItem(item.id, 'font', e.target.value)}>
                                                        <option value="matrix">點陣 (Matrix)</option>
                                                        <option value="digital">數位 (Digital)</option>
                                                    </select>
                                                </div>
                                            )}

                                            <div className="grid grid-cols-2 gap-2">
                                                <div className="flex items-center gap-2 bg-slate-900/50 p-1 rounded-lg border border-white/5">
                                                    {item.type === 'text' ? <><div title="尺寸 (整數)" className="text-slate-500 pl-1"><Icon name="size" className="w-3.5 h-3.5" /></div><input type="number" min="1" step="1" className="w-full bg-slate-950 p-1 text-[10px] rounded border border-white/5 text-white font-bold text-center" value={item.size} onChange={e=>updateItem(item.id, 'size', e.target.value === '' ? 1 : Math.max(1, parseInt(e.target.value)))} /></> : <><div title="方向" className="text-slate-500 pl-1"><Icon name={item.dir === 'H' ? 'arrowsH' : 'arrowsV'} className="w-3.5 h-3.5" /></div><div className="flex gap-1 p-0.5 bg-slate-950 rounded border border-white/5 flex-1"><button onClick={()=>updateItem(item.id, 'dir', 'H')} className={`flex-1 text-[8px] font-bold py-0.5 rounded transition-all ${item.dir==='H'?'bg-emerald-500 text-white shadow-lg':'text-slate-600'}`}>H</button><button onClick={()=>updateItem(item.id, 'dir', 'V')} className={`flex-1 text-[8px] font-bold py-0.5 rounded transition-all ${item.dir==='V'?'bg-emerald-500 text-white shadow-lg':'text-slate-600'}`}>V</button></div></>}
                                                </div>
                                                <div className="flex items-center gap-2 bg-slate-900/50 p-1 rounded-lg border border-white/5"><div title="色彩" className="text-slate-500 pl-1"><Icon name="palette" className="w-3.5 h-3.5" /></div><div className="relative flex-1 h-6 rounded overflow-hidden cursor-pointer border border-white/10"><input type="color" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" value={item.color} onChange={e=>updateItem(item.id, 'color', e.target.value)} /><div className="w-full h-full" style={{ backgroundColor: item.color }} /></div></div>
                                            </div>
                                            <div className="flex items-center gap-4 pt-1 border-t border-white/5">
                                                <div className="flex items-center gap-2 flex-1"><span className="text-[10px] font-black text-blue-500 italic leading-none">X</span><input type="number" className="w-full bg-slate-900 p-1 rounded border border-white/5 text-[10px] text-white text-center font-bold" value={item.x} onChange={e=>updateItem(item.id, 'x', e.target.value === '' ? '' : parseInt(e.target.value))} /></div>
                                                <div className="flex items-center gap-2 flex-1"><span className="text-[10px] font-black text-blue-500 italic leading-none">Y</span><input type="number" className="w-16 bg-slate-900 p-1 rounded border border-white/5 text-[10px] text-white text-center font-bold" value={item.y} onChange={e=>updateItem(item.id, 'y', e.target.value === '' ? '' : parseInt(e.target.value))} /></div>
                                            </div>

                                            {/* 還原線條專屬編輯器 */}
                                            {item.type === 'line' && (
                                                <div className="space-y-1 pt-1 border-t border-white/5 animate-in slide-in-from-top-1">
                                                    <div className="flex justify-between items-center text-[10px] font-bold uppercase"><span className="text-slate-500">Len: {item.len}</span><span className="text-slate-500 text-[9px]">Thick: {item.thick}</span></div>
                                                    <div className="flex gap-2 items-center">
                                                        <input type="range" min="1" max={stats.totalPxW} value={item.len} onChange={e=>updateItem(item.id, 'len', parseInt(e.target.value))} className="flex-1 h-1 accent-emerald-500 bg-slate-800 rounded-full appearance-none cursor-pointer" />
                                                        <input type="number" min="1" value={item.thick} onChange={e=>updateItem(item.id, 'thick', e.target.value === '' ? '' : parseInt(e.target.value))} className="w-10 bg-slate-900 text-[10px] text-white text-center rounded border border-white/5 font-bold" />
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* 代碼同步彈窗 */}
                    {showCodeExport && (
                        <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-[250] p-10 backdrop-blur-md">
                            <div className="bg-[#0a0a0a] border border-blue-500/30 w-full max-w-4xl p-8 rounded-[2rem] shadow-2xl flex flex-col max-h-[85vh] animate-in fade-in zoom-in-95">
                                <header className="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                                    <div><h2 className="text-2xl font-black text-blue-400 flex items-center gap-3"><Icon name="code" className="w-6 h-6" /> 控制器代碼同步</h2><p className="text-[10px] text-slate-500 uppercase tracking-widest mt-1">您可以自定義檔名或讀回舊代碼</p></div>
                                    <button onClick={()=>setShowCodeExport(false)} className="text-slate-600 hover:text-white transition-colors text-2xl font-light">✕</button>
                                </header>
                                
                                <div className="mb-4 flex items-center gap-4 bg-slate-900 p-3 rounded-2xl border border-white/5">
                                    <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">檔案名稱:</label>
                                    <input 
                                        className="bg-black border border-white/10 rounded-lg px-3 py-1.5 text-xs text-emerald-400 font-mono flex-1 outline-none focus:border-blue-500"
                                        value={customFileName} 
                                        onChange={(e)=>setCustomFileName(e.target.value)} 
                                        placeholder="例如: design.ino"
                                    />
                                </div>

                                <div className="flex-1 flex flex-col min-h-0 bg-black rounded-xl border border-white/5 relative group overflow-hidden">
                                    <textarea className="w-full h-full bg-transparent text-emerald-500 font-mono text-xs leading-relaxed p-4 outline-none custom-scrollbar resize-none" value={exportCode} onChange={(e) => setExportCode(e.target.value)} spellCheck="false" />
                                    <div className="absolute top-4 right-4 flex gap-2">
                                        <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileLoad} accept=".ino,.txt,.cpp,.h" />
                                        <button onClick={() => fileInputRef.current.click()} className="bg-slate-800 hover:bg-slate-700 text-white text-[10px] font-bold px-3 py-1.5 rounded uppercase flex items-center gap-2 border border-white/10 shadow-lg"><Icon name="open" className="w-3.5 h-3.5" /> Open File</button>
                                        <button onClick={() => copyToClipboard(exportCode)} className="bg-slate-800 hover:bg-slate-700 text-white text-[10px] font-bold px-3 py-1.5 rounded uppercase border border-white/10">Copy</button>
                                        <button onClick={downloadCodeFile} className="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold px-3 py-1.5 rounded uppercase flex items-center gap-2 shadow-lg"><Icon name="download" className="w-3.5 h-3.5" /> Save File</button>
                                    </div>
                                </div>
                                {parseError && <div className="mt-4 p-3 bg-red-500/10 border border-red-500/50 rounded-xl flex items-center gap-3 text-red-400 text-xs font-bold animate-in slide-in-from-top-2"><Icon name="alert" className="w-4 h-4" />{parseError}</div>}
                                <div className="mt-6 flex justify-between items-center">
                                    <button onClick={() => { if(parseAndReadCode(exportCode)) setShowCodeExport(false); }} className="bg-emerald-600 hover:bg-emerald-500 text-white px-8 py-3 rounded-xl font-bold text-xs uppercase tracking-widest flex items-center gap-3 transition-all shadow-lg shadow-emerald-500/20"><Icon name="refresh" className="w-4 h-4" /> 回讀並還原編輯</button>
                                    <button onClick={()=>setShowCodeExport(false)} className="px-8 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl font-bold text-xs uppercase tracking-widest text-white shadow-lg transition-all">關閉</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 電力詳細評估彈窗 */}
                    {showConfig && (
                        <div className="fixed inset-0 bg-black/85 flex items-center justify-center z-[200] p-6 backdrop-blur-lg">
                            <div className="bg-slate-900 border border-white/10 w-full max-w-md p-8 rounded-[2rem] shadow-2xl animate-in fade-in zoom-in-95">
                                <header className="flex justify-between items-center border-b border-white/5 pb-5"><h2 className="text-xl font-black text-blue-400 flex items-center gap-4 uppercase tracking-tighter"><Icon name="lightning" className="w-6 h-6 text-yellow-400" /> 電力詳細評估</h2><button onClick={()=>setShowConfig(false)} className="text-slate-600 hover:text-white transition-colors text-2xl font-light">✕</button></header>
                                <div className="space-y-6">
                                    <div className="bg-blue-600/5 p-6 rounded-3xl border border-blue-500/20 space-y-4 shadow-inner">
                                        <div className="flex justify-between items-center"><h3 className="text-[11px] font-black text-blue-400 uppercase tracking-widest flex items-center gap-2">AC 入電規劃</h3><div className="flex gap-2 p-1.5 bg-slate-950 rounded-xl"><button onClick={()=>setVoltageAC(110)} className={`px-4 py-1.5 rounded-lg text-[10px] font-black ${voltageAC===110?'bg-white text-black shadow-xl':'text-slate-600'}`}>110V</button><button onClick={()=>setVoltageAC(220)} className={`px-4 py-1.5 rounded-lg text-[10px] font-black ${voltageAC===220?'bg-white text-black shadow-xl':'text-slate-600'}`}>220V</button></div></div>
                                        <div className="space-y-3 font-mono text-xs text-slate-300">
                                            <div className="flex justify-between border-b border-white/5 pb-2"><span>系統總功率 (Peak)</span><span className="text-white font-bold">{stats.peakPower} W</span></div>
                                            <div className="flex justify-between"><span>AC 電流需求</span><span className="text-orange-400 font-bold">{stats.currentAC} A</span></div>
                                        </div>
                                    </div>
                                    <div className="bg-emerald-600/5 p-6 rounded-3xl border border-emerald-500/20 space-y-4 shadow-inner">
                                        <div className="flex justify-between items-center"><h3 className="text-[11px] font-black text-emerald-400 uppercase tracking-widest flex items-center gap-2">DC 直流端需求</h3>
                                            <select className="bg-slate-950 p-2 rounded-xl border border-white/10 text-[10px] text-white outline-none font-bold cursor-pointer transition-all hover:border-emerald-500/50" value={voltageDC} onChange={e=>setVoltageDC(parseFloat(e.target.value))}>
                                                <option value="3.3">3.3V</option>
                                                <option value="4.2">4.2V</option>
                                                <option value="5">5V</option>
                                                <option value="12">12V</option>
                                                <option value="24">24V</option>
                                            </select>
                                        </div>
                                        <div className="flex justify-between text-xs font-mono text-slate-300 pt-2 border-t border-white/5"><span>直流端總電流估算</span><span className="text-emerald-400 font-bold text-base">{stats.currentDC} A</span></div>
                                    </div>
                                </div>
                                <button onClick={()=>setShowConfig(false)} className="w-full bg-blue-600 mt-8 py-5 rounded-2xl font-black text-xs uppercase tracking-widest text-white shadow-lg shadow-blue-900/50">確認並返回</button>
                            </div>
                        </div>
                    )}

                    {/* BOM 清單視窗 */}
                    {showBOM && (
                        <div className="fixed inset-0 bg-black/98 flex items-center justify-center z-[250] p-10 backdrop-blur-xl">
                            <div className="bg-slate-900 border border-white/10 w-full max-w-4xl p-10 rounded-[3rem] shadow-2xl overflow-y-auto max-h-[90vh] custom-scrollbar animate-in slide-in-from-bottom-12">
                                <header className="flex justify-between items-center mb-10 border-b border-white/10 pb-8"><div><h2 className="text-3xl font-black text-blue-400 uppercase italic tracking-tighter">工程物料清單 (BOM)</h2><p className="text-[10px] text-slate-500 mt-2 uppercase tracking-[0.4em] font-sans font-bold">Engineering Build Details</p></div><button onClick={()=>setShowBOM(false)} className="bg-slate-800 p-3 rounded-2xl text-2xl font-light hover:text-white transition-colors">✕</button></header>
                                <div className="bg-white/5 p-8 rounded-[2rem] border border-white/5 space-y-4 mb-8">
                                    <div className="text-[10px] text-slate-500 mb-2 font-black uppercase border-b border-white/5 pb-2 tracking-widest">物理配置總覽</div>
                                    <div className="grid grid-cols-2 gap-x-12 gap-y-4 font-bold text-xs">
                                        <div className="flex justify-between"><span className="text-slate-400 uppercase tracking-tighter">型號規格</span><span className="text-white font-black">{modelKey} 系列</span></div>
                                        <div className="flex justify-between"><span className="text-slate-400 uppercase tracking-tighter">模組數量</span><span className="text-white font-black">{stats.moduleCount} Units</span></div>
                                        <div className="flex justify-between text-blue-400 pt-3 border-t border-white/10 col-span-2"><span className="uppercase text-[10px] font-black">顯示解析度</span><span className="font-black text-base">{stats.totalPxW} (W) x {stats.totalPxH} (H) Px</span></div>
                                    </div>
                                </div>
                                <div className="overflow-hidden rounded-3xl border border-white/10 mb-10 shadow-2xl"><table className="w-full text-xs text-left border-collapse"><thead className="bg-white/5 text-[10px] text-slate-500 uppercase tracking-widest"><tr><th className="p-5">物料名稱</th><th className="p-5">規格詳情</th><th className="p-5 text-right">數量</th></tr></thead><tbody className="divide-y divide-white/10 bg-slate-900/40 font-mono">
                                    <tr className="hover:bg-white/5 transition-colors"><td className="p-5 font-black text-slate-300 uppercase">LED Module</td><td>{modelKey} 點陣顯示模組 ({spec.pxW}x{spec.pxH}px)</td><td className="p-5 text-right font-black text-blue-400">{stats.moduleCount} 片</td></tr>
                                    <tr className="hover:bg-white/5 transition-colors"><td className="p-5 font-black text-slate-300 uppercase">PSU Power</td><td>DC {voltageDC}V / 200W 高效率電源供應器</td><td className="p-5 text-right font-black text-blue-400">{stats.psuCount} 台</td></tr>
                                    <tr className="hover:bg-white/5 transition-colors"><td className="p-5 font-black text-slate-300 uppercase">Receiver Card</td><td>MRV同步接收卡</td><td className="p-5 text-right font-black text-blue-400">{stats.receiverCount} 片</td></tr>
                                    <tr className="hover:bg-blue-400/10 text-blue-400 transition-colors border-t-2 border-blue-500/20"><td className="p-6 font-black uppercase text-blue-400">AC Control Box</td><td>AC 配電控制箱 (含漏電保護)</td><td className="p-6 text-right font-black text-lg text-blue-400">1 套</td></tr>
                                </tbody></table></div>
                                <div className="flex gap-6"><button onClick={()=>window.print()} className="flex-1 bg-blue-600 py-6 rounded-3xl font-black text-sm uppercase tracking-widest shadow-lg shadow-blue-900/50 hover:scale-[1.01] transition-all text-white">列印報表</button><button onClick={()=>setShowBOM(false)} className="flex-[0.4] bg-slate-800 py-6 rounded-3xl font-black text-sm tracking-widest text-white">返回</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>