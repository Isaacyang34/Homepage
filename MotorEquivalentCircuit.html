<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>馬達等效電路參數計算器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        
        /* Circuit Diagram Font Styles */
        .circuit-text { 
            font-family: 'Courier New', monospace; 
            font-weight: 800; 
            fill: #0284c7; 
            font-size: 18px;
            filter: drop-shadow(0 1px 1px white);
        }
        .circuit-label { 
            font-family: sans-serif; 
            font-weight: bold; 
            fill: #1e293b; 
            font-size: 20px;
        }
        .current-text {
            font-weight: bold;
            font-size: 16px;
            fill: #1e293b;
            font-style: italic;
        }

        input:focus { outline: none; border-color: #3b82f6; ring: 2px; }
        
        /* Input Styles */
        .input-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .input-row:last-child { border-bottom: none; }
        .input-label {
            font-size: 1.25rem;
            font-weight: 800;
            color: #1e293b;
            flex-grow: 1;
            white-space: nowrap;
            margin-right: 16px;
        }
        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 180px;
            flex-shrink: 0;
            position: relative; /* For error icon positioning */
        }
        .input-field {
            width: 100%;
            background-color: #f8fafc;
            border: 2px solid #cbd5e1;
            border-radius: 6px;
            padding: 6px 12px;
            text-align: right;
            font-weight: 700;
            font-size: 1.25rem;
            color: #0f172a;
            transition: all 0.2s;
        }
        .input-field:focus {
            background-color: white;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        /* Error Styles */
        .input-field.error {
            background-color: #fee2e2 !important; /* Red 100 */
            border-color: #ef4444 !important; /* Red 500 */
            color: #b91c1c !important; /* Red 700 */
        }
        
        .warning-icon {
            position: absolute;
            left: -32px; /* Position to the left of the input */
            top: 50%;
            transform: translateY(-50%);
            color: #ef4444; /* Red 500 */
            display: none; /* Hidden by default */
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }

        .input-unit {
            font-size: 1rem;
            color: #64748b;
            font-weight: 700;
            width: 50px;
            text-align: left;
        }
        
        /* Result List Styles */
        .result-item {
            padding: 10px 16px;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            font-family: 'Courier New', monospace;
            font-weight: 700;
            color: #334155;
            display: flex;
            align-items: center;
            font-size: 1.5rem;
        }
        .result-item:last-child { border-bottom: none; }
        .result-val { color: #2563eb; font-weight: 800; margin: 0 6px; }
        .result-desc { 
            font-family: 'Noto Sans TC', sans-serif; 
            font-weight: 500; 
            font-size: 1.1rem; 
            color: #64748b; 
            margin-right: 12px; 
        }

        /* --- Cyberpunk Chart Styles --- */
        .cyber-container {
            --neon-blue: #00f2ff;
            --neon-pink: #ff3399;
            --neon-pink-glow: rgba(255, 51, 153, 0.9);
            --bg-dark: #000000;
            background-color: var(--bg-dark);
            font-family: 'Orbitron', sans-serif;
            overflow: hidden;
            position: relative;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }

        .cyber-grid-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 50% 50%, #001a1a 0%, #000 85%),
                linear-gradient(rgba(0, 242, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.05) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            z-index: 0;
        }

        .cyber-svg { width: 100%; height: 100%; z-index: 10; position: relative; filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.5)); }
        .node-text { fill: white; font-size: 40px; font-weight: 900; text-anchor: middle; filter: drop-shadow(0 0 8px #00f2ff); }
        .node-val { fill: #00f2ff; font-size: 32px; font-family: 'Courier New', monospace; font-weight: 800; text-anchor: middle; filter: drop-shadow(0 0 4px #00f2ff); }
        .loss-text { fill: #fff; font-size: 28px; font-weight: 800; filter: drop-shadow(0 0 10px #ff3399); }
        .loss-val { fill: #ff3399; font-size: 28px; font-family: 'Courier New', monospace; font-weight: 800; filter: drop-shadow(0 0 8px #ff3399); }
        .main-line { fill: none; stroke: #00f2ff; stroke-width: 5; filter: drop-shadow(0 0 8px #00f2ff); }
        .branch-line { fill: none; stroke: #ff3399; stroke-width: 4; stroke-dasharray: 12, 6; filter: drop-shadow(0 0 15px rgba(255, 51, 153, 0.9)); }
        .particle { fill: #fff; filter: blur(2px) drop-shadow(0 0 5px #fff); }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">

    <!-- Header -->
    <header class="bg-blue-800 text-white p-6 shadow-xl sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-black flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                馬達等效電路參數分析 (三相)
            </h1>
            <span class="text-lg opacity-90 font-bold bg-blue-900 px-3 py-1 rounded">IEEE T-Model Analysis</span>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">

        <!-- Left Column: Inputs -->
        <div class="lg:col-span-5 space-y-6">
            
            <!-- Step 1: Basic Data -->
            <div class="bg-white rounded-2xl shadow-md border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 px-8 py-5 border-b border-slate-200 flex justify-between items-center">
                    <h2 class="text-2xl font-black text-slate-800">Step 1: 馬達基本資料</h2>
                    <div class="flex items-center gap-4">
                        <!-- Connection Type Toggle Switch -->
                        <div class="relative flex items-center bg-slate-200 rounded-lg p-1 cursor-pointer select-none" onclick="toggleConnection()" title="切換接線方式">
                            <div id="switch-y" class="px-3 py-1 rounded-md font-bold transition-all duration-200 bg-white text-blue-700 shadow-sm" style="min-width: 40px; text-align: center;">Y</div>
                            <div id="switch-d" class="px-3 py-1 rounded-md font-bold transition-all duration-200 text-slate-400" style="min-width: 40px; text-align: center;">Δ</div>
                        </div>
                        <input type="hidden" id="conn_type" value="Y">

                        <span class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-bold">額定測試</span>
                    </div>
                </div>
                <div class="p-6 pt-4">
                    <div class="input-row">
                        <div class="flex flex-col">
                            <label class="input-label">額定電壓 Vr</label>
                            <span class="text-sm text-slate-500 font-medium">(Phase to Phase)</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="number" id="v_rated" value="230.0" class="input-field">
                            <span class="input-unit">V</span>
                        </div>
                    </div>
                    <div class="input-row"><label class="input-label">額定頻率 Fr</label><div class="input-wrapper"><input type="number" id="f_rated" value="100.0" class="input-field"><span class="input-unit">Hz</span></div></div>
                    <div class="input-row"><label class="input-label">額定轉速 Nr</label><div class="input-wrapper"><input type="number" id="n_rated" value="2930.0" class="input-field"><span class="input-unit">rpm</span></div></div>
                    
                    <!-- Modified Power Inputs -->
                    <div class="input-row">
                        <div class="flex flex-col">
                            <label class="input-label">額定輸入功率 Pr-in</label>
                            <span class="text-sm text-slate-500 font-medium">(PowerMeter 顯示)</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="number" id="pi_rated" value="6.2" class="input-field">
                            <span class="input-unit">kW</span>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="flex flex-col">
                            <label class="input-label">額定輸出功率 Pr-out</label>
                            <span class="text-sm text-slate-500 font-medium">(扭力計量測)</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="number" id="po_rated" value="5.5" class="input-field">
                            <span class="input-unit">kW</span>
                        </div>
                    </div>

                    <!-- New: Power Factor and Efficiency -->
                    <div class="input-row">
                        <label class="input-label">額定功率因數 PF</label>
                        <div class="input-wrapper">
                            <input type="number" id="pf_rated" value="0.85" step="0.01" min="0" max="1" class="input-field">
                            <span class="input-unit"></span>
                        </div>
                    </div>

                    <div class="input-row">
                        <label class="input-label">額定效率 Eff</label>
                        <div class="input-wrapper">
                            <input type="number" id="eff_input_rated" value="88.7" step="0.1" min="0" max="100" class="input-field">
                            <span class="input-unit">%</span>
                        </div>
                    </div>

                    <div class="input-row">
                        <label class="input-label">額定電流 Ir</label>
                        <div class="input-wrapper">
                            <input type="number" id="i_rated" value="17.5" class="input-field">
                            <span class="input-unit">A</span>
                        </div>
                    </div>

                    <div class="input-row"><label class="input-label">極數 Poles</label><div class="input-wrapper"><input type="number" id="poles" value="4" class="input-field"><span class="input-unit">P</span></div></div>
                </div>
            </div>

            <!-- Step 2: Resistance & L -->
            <div class="bg-white rounded-2xl shadow-md border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 px-8 py-5 border-b border-slate-200 flex justify-between items-center">
                    <h2 class="text-2xl font-black text-slate-800">Step 2: 靜態量測</h2>
                    <span class="text-sm bg-green-100 text-green-800 px-3 py-1 rounded-full font-bold">LCR Meter 量測</span>
                </div>
                <div class="p-6 pt-4">
                    <div class="input-row">
                        <div class="flex flex-col">
                            <!-- Corrected Label -->
                            <label class="input-label">定子相電阻 Rs</label>
                            <!-- Dynamic Note via JS -->
                            <span id="note_rs" class="text-sm text-slate-500 font-medium">(Y接法/Phase)</span>
                        </div>
                        <div class="input-wrapper">
                            <!-- Adjusted default value from 0.28 to 0.14 to reflect phase resistance -->
                            <input type="number" id="r_avg" value="0.14" class="input-field bg-yellow-50 border-yellow-400">
                            <span class="input-unit">Ω</span>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="flex flex-col">
                            <!-- Corrected Label -->
                            <label class="input-label">定子電感 Ls</label>
                            <!-- Removed Note -->
                        </div>
                        <div class="input-wrapper">
                            <input type="number" id="l_phase" value="1.5" placeholder="選填" class="input-field">
                            <span class="input-unit">mH</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: No Load -->
            <div class="bg-white rounded-2xl shadow-md border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 px-8 py-5 border-b border-slate-200 flex justify-between items-center">
                    <h2 class="text-2xl font-black text-slate-800">Step 3: 無載測試</h2>
                    <span class="text-sm bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full font-bold">額定轉速無載運轉</span>
                </div>
                <div class="p-6 pt-4">
                    <div class="input-row">
                        <label class="input-label">無載電壓 Vn</label>
                        <div class="input-wrapper">
                            <!-- Error Icon -->
                            <div id="icon_vn_nl" class="warning-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            <input type="number" id="vn_nl" value="132.8" class="input-field bg-yellow-50 border-yellow-400">
                            <span class="input-unit">V</span>
                        </div>
                    </div>
                    <div class="input-row">
                        <label class="input-label">無載電流 In</label>
                        <div class="input-wrapper">
                            <div id="icon_in_nl" class="warning-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            <input type="number" id="in_nl" value="8.85" class="input-field bg-yellow-50 border-yellow-400">
                            <span class="input-unit">A</span>
                        </div>
                    </div>
                    <div class="input-row">
                        <label class="input-label">無載功率 Pn</label>
                        <div class="input-wrapper">
                            <div id="icon_pn_nl" class="warning-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            <input type="number" id="pn_nl" value="505.0" class="input-field bg-yellow-50 border-yellow-400">
                            <span class="input-unit">W</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Blocked Rotor Test -->
            <div class="bg-white rounded-2xl shadow-md border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 px-8 py-5 border-b border-slate-200 flex justify-between items-center">
                    <h2 class="text-2xl font-black text-slate-800">Step 4: 堵轉測試</h2>
                    <span class="text-sm bg-red-100 text-red-800 px-3 py-1 rounded-full font-bold">堵轉 (Locked Rotor) 測試</span>
                </div>
                <div class="p-6 pt-4">
                    <div class="input-row">
                        <label class="input-label">堵轉電壓 Vbr</label>
                        <div class="input-wrapper">
                            <div id="icon_v_br" class="warning-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            <input type="number" id="v_br" value="35.0" class="input-field bg-red-50 border-red-200">
                            <span class="input-unit">V</span>
                        </div>
                    </div>
                    <div class="input-row">
                        <label class="input-label">堵轉電流 Ibr</label>
                        <div class="input-wrapper">
                            <div id="icon_i_br" class="warning-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            <input type="number" id="i_br" value="17.5" class="input-field bg-red-50 border-red-200">
                            <span class="input-unit">A</span>
                        </div>
                    </div>
                    <div class="input-row">
                        <label class="input-label">堵轉功率 Pbr</label>
                        <div class="input-wrapper">
                            <div id="icon_p_br" class="warning-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            <input type="number" id="p_br" value="820.0" class="input-field bg-red-50 border-red-200">
                            <span class="input-unit">W</span>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="calculate()" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-black py-5 px-6 rounded-2xl shadow-lg hover:shadow-xl transition duration-200 flex justify-center items-center gap-3 text-2xl transform active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm2 10a1 1 0 10-2 0v3a1 1 0 102 0v-3zm2-3a1 1 0 011 1v5a1 1 0 11-2 0v-5a1 1 0 011-1zm4-1a1 1 0 10-2 0v7a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                執行計算
            </button>
        </div>

        <!-- Right Column: Diagram & Results -->
        <div class="lg:col-span-7 space-y-8">
            
            <!-- Circuit Diagram Card -->
            <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
                <div class="bg-slate-800 text-white px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                    <h2 class="font-bold text-xl">單相等效電路 (IEEE T-Model)</h2>
                    <span class="text-sm bg-slate-600 px-3 py-1 rounded-full">IEEE Standard Reference</span>
                </div>
                <div class="p-6 overflow-x-auto bg-white flex justify-center items-center" id="diagram-container">
                    <svg width="1000" height="520" viewBox="0 0 1000 520" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <marker id="arrow-blk" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto"><path d="M0,0 L0,8 L8,4 z" fill="#1e293b" /></marker>
                            <marker id="arrow-res" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L0,6 L6,3 z" fill="#1e293b" /></marker>
                        </defs>
                        <text x="240" y="30" text-anchor="middle" class="circuit-label">定子側 (Stator)</text>
                        <text x="500" y="65" text-anchor="middle" class="circuit-label" style="fill: #64748b; font-size:18px;">氣隙 (Air Gap)</text>
                        <text x="800" y="30" text-anchor="middle" class="circuit-label">轉子側 (Rotor)</text>
                        <line x1="380" y1="10" x2="380" y2="490" stroke="#cbd5e1" stroke-width="2" stroke-dasharray="8,4" />
                        <line x1="620" y1="10" x2="620" y2="490" stroke="#cbd5e1" stroke-width="2" stroke-dasharray="8,4" />
                        <circle cx="50" cy="180" r="4" fill="white" stroke="#1e293b" stroke-width="2" />
                        <circle cx="50" cy="465" r="4" fill="white" stroke="#1e293b" stroke-width="2" />
                        <text x="45" y="330" font-size="28" font-weight="900" text-anchor="end" fill="#1e293b">V1</text>
                        <text x="50" y="240" font-size="24" text-anchor="middle" fill="#1e293b">-</text>
                        <text x="50" y="445" font-size="24" text-anchor="middle" fill="#1e293b">+</text>
                        <line x1="54" y1="180" x2="140" y2="180" stroke="#1e293b" stroke-width="2" />
                        <polyline points="140,180 150,165 165,195 180,165 195,195 210,165 225,195 235,180" fill="none" stroke="#1e293b" stroke-width="2" />
                        <text x="187" y="145" font-size="22" font-weight="bold" text-anchor="middle" fill="#1e293b">R1</text>
                        <text id="val-r1-svg" x="187" y="220" text-anchor="middle" class="circuit-text">[-.---]Ω</text>
                        <line x1="235" y1="180" x2="280" y2="180" stroke="#1e293b" stroke-width="2" />
                        <line x1="280" y1="180" x2="305" y2="180" stroke="#1e293b" stroke-width="2" marker-end="url(#arrow-blk)" />
                        <text x="290" y="170" class="current-text">I1</text>
                        <path d="M305,180 c15,-30 35,-30 40,0 c5,-30 25,-30 30,0 c5,-30 25,-30 30,0 c5,-30 25,-30 30,0" fill="none" stroke="#1e293b" stroke-width="2" />
                        <text x="380" y="145" font-size="22" font-weight="bold" text-anchor="middle" fill="#1e293b">jX1</text>
                        <text id="val-x1-svg" x="380" y="220" text-anchor="middle" class="circuit-text">[-.---]Ω</text>
                        <line x1="435" y1="180" x2="500" y2="180" stroke="#1e293b" stroke-width="2" />
                        <circle cx="500" cy="180" r="3" fill="#1e293b" />
                        <line x1="500" y1="180" x2="500" y2="230" stroke="#1e293b" stroke-width="2" />
                        <text x="515" y="225" class="current-text">Iφ</text>
                        <line x1="365" y1="230" x2="635" y2="230" stroke="#1e293b" stroke-width="2" />
                        <line x1="365" y1="230" x2="365" y2="250" stroke="#1e293b" stroke-width="2" marker-end="url(#arrow-blk)" />
                        <text x="350" y="255" class="current-text" text-anchor="end">Ic</text>
                        <polyline points="365,270 350,285 380,300 350,315 380,330 350,345 380,360 365,370" fill="none" stroke="#1e293b" stroke-width="2" />
                        <text x="330" y="325" font-size="22" font-weight="bold" text-anchor="end" fill="#1e293b">Rc</text>
                        <text id="val-rc-svg" x="330" y="355" text-anchor="end" class="circuit-text" style="font-size:16px;">[-.---]Ω</text>
                        <line x1="365" y1="370" x2="365" y2="430" stroke="#1e293b" stroke-width="2" />
                        <line x1="635" y1="230" x2="635" y2="270" stroke="#1e293b" stroke-width="2" />
                        <path d="M635,270 c30,10 30,30 0,35 c30,10 30,30 0,35 c30,10 30,30 0,35 c30,10 30,30 0,35" fill="none" stroke="#1e293b" stroke-width="2" />
                        <text x="660" y="325" font-size="22" font-weight="bold" text-anchor="start" fill="#1e293b">jXm</text>
                        <text id="val-xm-svg" x="660" y="355" text-anchor="start" class="circuit-text" style="font-size:16px;">[-.---]Ω</text>
                        <line x1="635" y1="405" x2="635" y2="425" stroke="#1e293b" stroke-width="2" marker-end="url(#arrow-blk)" />
                        <text x="650" y="445" class="current-text">Im</text>
                        <line x1="365" y1="430" x2="635" y2="430" stroke="#1e293b" stroke-width="2" />
                        <line x1="500" y1="430" x2="500" y2="465" stroke="#1e293b" stroke-width="2" />
                        <circle cx="500" cy="430" r="3" fill="#1e293b" />
                        <line x1="500" y1="180" x2="580" y2="180" stroke="#1e293b" stroke-width="2" marker-end="url(#arrow-blk)" />
                        <text x="595" y="170" class="current-text">I2'</text>
                        <line x1="580" y1="180" x2="710" y2="180" stroke="#1e293b" stroke-width="2" />
                        <path d="M710,180 c15,-30 35,-30 40,0 c5,-30 25,-30 30,0 c5,-30 25,-30 30,0 c5,-30 25,-30 30,0" fill="none" stroke="#1e293b" stroke-width="2" />
                        <text x="785" y="145" font-size="22" font-weight="bold" text-anchor="middle" fill="#1e293b">jX2'</text>
                        <text id="val-x2-svg" x="785" y="220" text-anchor="middle" class="circuit-text">[-.---]Ω</text>
                        <line x1="840" y1="180" x2="920" y2="180" stroke="#1e293b" stroke-width="2" />
                        <line x1="920" y1="180" x2="920" y2="265" stroke="#1e293b" stroke-width="2" />
                        <polyline points="920,265 905,280 935,295 905,310 935,325 905,340 935,355 920,370" fill="none" stroke="#1e293b" stroke-width="2" />
                        <text x="965" y="325" font-size="24" font-weight="black" text-anchor="start" fill="#1e293b">R2'/s</text>
                        <text id="val-r2s-svg" x="965" y="355" text-anchor="start" class="circuit-text">[-.---]Ω</text>
                        <line x1="890" y1="355" x2="955" y2="295" stroke="#1e293b" stroke-width="2" marker-end="url(#arrow-res)" />
                        <line x1="920" y1="370" x2="920" y2="465" stroke="#1e293b" stroke-width="2" />
                        <line x1="50" y1="465" x2="920" y2="465" stroke="#1e293b" stroke-width="2" />
                    </svg>
                </div>
            </div>

            <!-- Parameters Table -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200">
                <div class="px-8 py-5 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-2xl text-slate-800">參數列表 (Parameters)</h3>
                </div>
                <div class="divide-y divide-slate-100 bg-white">
                    <div class="result-item grid grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <span class="mr-3 font-black text-blue-300 w-6 text-center">1.</span>
                            <span class="result-val w-12 text-left">R1</span>
                            <span class="result-desc">(定子電阻)</span>
                        </div>
                        <div class="text-left text-xl">
                            <span>[</span><span id="list-r1" class="result-val">-</span><span>]</span>
                            <span class="ml-2">Ω</span>
                        </div>
                    </div>
                    <div class="result-item grid grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <span class="mr-3 font-black text-blue-300 w-6 text-center">2.</span>
                            <span class="result-val w-12 text-left">R2'</span>
                            <span class="result-desc">(折算後轉子電阻)</span>
                        </div>
                        <div class="text-left text-xl">
                            <span>[</span><span id="list-r2" class="result-val">-</span><span>]</span>
                            <span class="ml-2">Ω</span>
                        </div>
                    </div>
                    <div class="result-item grid grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <span class="mr-3 font-black text-blue-300 w-6 text-center">3.</span>
                            <span class="result-val w-12 text-left">X1</span>
                            <span class="result-desc">(定子漏抗)</span>
                        </div>
                        <div class="text-left text-xl">
                            <span>[</span><span id="list-x1" class="result-val">-</span><span>]</span>
                            <span class="ml-2">Ω =</span>
                            <span>[</span><span id="list-l1" class="result-val text-slate-600">-</span><span>]</span>
                            <span class="ml-2">mH</span>
                        </div>
                    </div>
                    <div class="result-item grid grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <span class="mr-3 font-black text-blue-300 w-6 text-center">4.</span>
                            <span class="result-val w-12 text-left">X2'</span>
                            <span class="result-desc">(折算後轉子漏抗)</span>
                        </div>
                        <div class="text-left text-xl">
                            <span>[</span><span id="list-x2" class="result-val">-</span><span>]</span>
                            <span class="ml-2">Ω =</span>
                            <span>[</span><span id="list-l2" class="result-val text-slate-600">-</span><span>]</span>
                            <span class="ml-2">mH</span>
                        </div>
                    </div>
                    <div class="result-item grid grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <span class="mr-3 font-black text-blue-300 w-6 text-center">5.</span>
                            <span class="result-val w-12 text-left">Xm</span>
                            <span class="result-desc">(激磁電抗)</span>
                        </div>
                        <div class="text-left text-xl">
                            <span>[</span><span id="list-xm" class="result-val">-</span><span>]</span>
                            <span class="ml-2">Ω =</span>
                            <span>[</span><span id="list-lm" class="result-val text-slate-600">-</span><span>]</span>
                            <span class="ml-2">mH</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 馬達效率分析 -->
            <div class="bg-black rounded-2xl shadow-2xl border-2 border-slate-700 overflow-hidden">
                <div class="bg-slate-900 px-8 py-5 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="font-bold text-2xl text-white" style="font-family: 'Orbitron', sans-serif;">馬達效率分析</h3>
                </div>
                <div class="cyber-container w-full h-[600px]"><div class="cyber-grid-bg"></div>
                    <svg class="cyber-svg" viewBox="0 0 1800 900" xmlns="http://www.w3.org/2000/svg">
                        <defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#00151a;stop-opacity:1" /><stop offset="100%" style="stop-color:#003344;stop-opacity:1" /></linearGradient><marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><path d="M 0 0 L 8 3 L 0 6 Z" fill="#00f2ff" /></marker></defs>
                        <path id="path1" d="M 370 450 L 550 450" class="main-line" marker-end="url(#arrowhead)" /><circle r="6" class="particle"><animateMotion id="anim1" begin="indefinite" dur="3s" repeatCount="indefinite"><mpath href="#path1"/></animateMotion></circle>
                        <path id="path2" d="M 870 450 L 1000 450" class="main-line" marker-end="url(#arrowhead)" /><circle r="6" class="particle"><animateMotion id="anim2" begin="indefinite" dur="3s" repeatCount="indefinite"><mpath href="#path2"/></animateMotion></circle>
                        <path id="path3" d="M 1320 450 L 1450 450" class="main-line" marker-end="url(#arrowhead)" /><circle r="6" class="particle"><animateMotion id="anim3" begin="indefinite" dur="3s" repeatCount="indefinite"><mpath href="#path3"/></animateMotion></circle>
                        <path d="M 420 450 L 500 200 L 650 200" class="branch-line" /><text x="575" y="170" class="loss-text" text-anchor="middle">定子銅損 Pcu1</text><text x="575" y="240" class="loss-val" id="svg-val-pcu1" text-anchor="middle">- W</text>
                        <path d="M 420 450 L 500 700 L 650 700" class="branch-line" /><text x="575" y="730" class="loss-text" text-anchor="middle">鐵損 Pcore</text><text x="575" y="770" class="loss-val" id="svg-val-pcore" text-anchor="middle">- W</text>
                        <path d="M 900 450 L 980 200 L 1130 200" class="branch-line" /><text x="1055" y="170" class="loss-text" text-anchor="middle">轉子銅損 Pcu2</text><text x="1055" y="240" class="loss-val" id="svg-val-pcu2" text-anchor="middle">- W</text>
                        <path d="M 1350 450 L 1430 700 L 1580 700" class="branch-line" /><text x="1505" y="730" class="loss-text" text-anchor="middle">機械+雜散損 Pfw+Str</text><text x="1505" y="770" class="loss-val" id="svg-val-pfw" text-anchor="middle">- W</text>
                        <rect x="50" y="360" width="320" height="180" rx="8" stroke="#00f2ff" stroke-width="4" fill="url(#grad1)" /><text x="210" y="420" class="node-text">輸入功率</text><text x="210" y="480" class="node-val" id="svg-val-pin">Pin</text>
                        <rect x="550" y="360" width="320" height="180" rx="8" stroke="#00f2ff" stroke-width="4" fill="url(#grad1)" /><text x="710" y="420" class="node-text">氣隙功率</text><text x="710" y="480" class="node-val" id="svg-val-pg">Pg</text>
                        <rect x="1000" y="360" width="320" height="180" rx="8" stroke="#00f2ff" stroke-width="4" fill="url(#grad1)" /><text x="1160" y="420" class="node-text">機械功率</text><text x="1160" y="480" class="node-val" id="svg-val-pm">Pm</text>
                        <rect x="1450" y="360" width="300" height="180" rx="8" stroke="#00f2ff" stroke-width="4" fill="url(#grad1)" /><text x="1600" y="420" class="node-text">輸出功率</text><text x="1600" y="480" class="node-val" id="svg-val-pout">Pout</text>
                    </svg>
                </div>
                <div class="bg-black p-5 text-center border-t border-slate-800 flex justify-center items-center gap-4"><span class="text-[#00f2ff] font-mono text-2xl font-bold">CALCULATED EFFICIENCY:</span><span class="text-[#ff3399] font-mono text-4xl font-black" id="val-eff">- %</span></div>
            </div>
        </div>
    </main>

    <script>
        class Complex {
            constructor(re, im) { this.re = re; this.im = im; }
            add(c) { return new Complex(this.re + c.re, this.im + c.im); }
            sub(c) { return new Complex(this.re - c.re, this.im - c.im); }
            mul(c) { return new Complex(this.re * c.re - this.im * c.im, this.re * c.im + this.im * c.re); }
            div(c) {
                const den = c.re * c.re + c.im * c.im;
                return new Complex((this.re * c.re + this.im * c.im) / den, (this.im * c.re - this.re * c.im) / den);
            }
            mag() { return Math.sqrt(this.re * this.re + this.im * this.im); }
        }

        function toggleConnection() {
            const current = document.getElementById('conn_type').value;
            const next = current === 'Y' ? 'D' : 'Y';
            document.getElementById('conn_type').value = next;
            
            // Update Switch UI
            const btnY = document.getElementById('switch-y');
            const btnD = document.getElementById('switch-d');
            
            if (next === 'Y') {
                btnY.className = "px-3 py-1 rounded-md font-bold transition-all duration-200 bg-white text-blue-700 shadow-sm";
                btnD.className = "px-3 py-1 rounded-md font-bold transition-all duration-200 text-slate-400";
            } else {
                btnY.className = "px-3 py-1 rounded-md font-bold transition-all duration-200 text-slate-400";
                btnD.className = "px-3 py-1 rounded-md font-bold transition-all duration-200 bg-white text-blue-700 shadow-sm";
            }
            
            updateConnectionMode();
        }

        function updateConnectionMode() {
            const conn = document.getElementById('conn_type').value;
            const noteRs = document.getElementById('note_rs');
            
            if (conn === 'Y') {
                noteRs.textContent = '(Y接法/Phase)';
            } else {
                noteRs.textContent = '(Δ接法/Phase)';
            }
            calculate();
        }

        function setError(id, isError) {
            const el = document.getElementById(id);
            const iconId = 'icon_' + id;
            const icon = document.getElementById(iconId);
            
            if (isError) {
                el.classList.add('error');
                if (icon) icon.style.display = 'block';
            } else {
                el.classList.remove('error');
                if (icon) icon.style.display = 'none';
            }
        }

        function clearErrors() {
            const ids = ['v_br', 'i_br', 'p_br', 'vn_nl', 'in_nl', 'pn_nl'];
            ids.forEach(id => setError(id, false));
        }

        function calculate() {
            clearErrors(); // Reset error state

            const connType = document.getElementById('conn_type').value;
            const V_rated_input = parseFloat(document.getElementById('v_rated').value);
            const F_rated = parseFloat(document.getElementById('f_rated').value);
            const N_rated = parseFloat(document.getElementById('n_rated').value);
            
            // Step 1: Power Inputs
            const P_in_rated_kw = parseFloat(document.getElementById('pi_rated').value);
            const P_out_rated_kw = parseFloat(document.getElementById('po_rated').value);
            const PF_rated = parseFloat(document.getElementById('pf_rated').value);
            const Eff_rated_pct = parseFloat(document.getElementById('eff_input_rated').value);
            const I_rated_input = parseFloat(document.getElementById('i_rated').value);
            
            const Poles = parseFloat(document.getElementById('poles').value);
            const R_input = parseFloat(document.getElementById('r_avg').value); // Phase Resistance
            const L_phase_mH = parseFloat(document.getElementById('l_phase').value) || 0;
            const V_nl_input = parseFloat(document.getElementById('vn_nl').value);
            const I_nl_input = parseFloat(document.getElementById('in_nl').value);
            const P_nl_total = parseFloat(document.getElementById('pn_nl').value);

            const V_br_input = parseFloat(document.getElementById('v_br').value) || 0;
            const I_br_input = parseFloat(document.getElementById('i_br').value) || 0;
            const P_br_total = parseFloat(document.getElementById('p_br').value) || 0;

            // Updated: Phase Calculations based on Connection Type
            
            let V_rated_phase, V_nl_phase, V_br_phase;
            let I_rated_phase, I_nl_phase, I_br_phase;

            if (connType === 'Y') {
                // Y: V_ph = V_line / sqrt(3), I_ph = I_line
                V_rated_phase = V_rated_input / Math.sqrt(3);
                V_nl_phase = V_nl_input / Math.sqrt(3);
                V_br_phase = V_br_input / Math.sqrt(3);
                I_rated_phase = I_rated_input;
                I_nl_phase = I_nl_input;
                I_br_phase = I_br_input;
            } else {
                // Delta: V_ph = V_line, I_ph = I_line / sqrt(3)
                V_rated_phase = V_rated_input;
                V_nl_phase = V_nl_input;
                V_br_phase = V_br_input;
                I_rated_phase = I_rated_input / Math.sqrt(3);
                I_nl_phase = I_nl_input / Math.sqrt(3);
                I_br_phase = I_br_input / Math.sqrt(3);
            }

            const P_nl_phase = P_nl_total / 3;
            const N_sync = (120 * F_rated) / Poles;
            const s_rated = (N_sync - N_rated) / N_sync;
            const omega = 2 * Math.PI * F_rated;

            // Resistance is Phase Resistance directly
            let R1 = R_input; 
            let X1, X2, R2;

            if (V_br_input > 0 && I_br_input > 0) {
                // Locked Rotor Analysis using Phase Values
                const P_br_phase = P_br_total / 3;
                const S_br_phase = V_br_phase * I_br_phase;
                
                // Check for unreasonable data: PF > 1
                if (P_br_phase > S_br_phase + 0.1) { // Add small tolerance
                    setError('p_br', true);
                    setError('v_br', true);
                    setError('i_br', true);
                }

                // Safety: Cap Power at Apparent Power (PF <= 1.0) for calculation
                const P_calc = Math.min(P_br_phase, S_br_phase);
                
                const R_br = P_calc / (I_br_phase ** 2);
                const Z_br = V_br_phase / I_br_phase;
                
                // Calculate X
                const X_br = Math.sqrt(Math.max(0, Z_br**2 - R_br**2));
                
                X1 = X_br / 2;
                X2 = X_br / 2;
                
                // Ensure R2 is positive (R_br is R1 + R2')
                R2 = Math.max(0.01, R_br - R1);
            } else {
                X1 = L_phase_mH > 0 ? omega * (L_phase_mH / 1000) : 0.1 * (V_rated_phase / I_rated_phase);
                X2 = X1;
                const P_out_target = P_out_rated_kw * 1000;
                const P_gap_est = P_out_target / (1 - s_rated);
                R2 = (s_rated * P_gap_est) / (3 * (I_rated_phase * 0.9)**2);
            }

            // No Load Validation
            const S_nl_phase = V_nl_phase * I_nl_phase;
            if (P_nl_phase > S_nl_phase + 0.1) {
                setError('pn_nl', true);
                setError('vn_nl', true);
                setError('in_nl', true);
            }

            const P_scl_nl = (I_nl_phase ** 2) * R1;
            const P_const_total = Math.max(0, P_nl_total - 3 * P_scl_nl);
            const P_core_const = P_const_total * 0.65; // Approx 65% Core Loss part

            const E1_nl_mag = V_nl_phase - (I_nl_phase * X1);
            let Rc = (E1_nl_mag ** 2) / (P_core_const / 3);
            
            const Q_nl = Math.sqrt(Math.max(0, (V_nl_phase * I_nl_phase)**2 - P_nl_phase**2));
            const Q_mag = Math.max(1, Q_nl - (I_nl_phase**2) * X1);
            let Xm = (E1_nl_mag ** 2) / Q_mag;
            if (!isFinite(Xm) || Xm < 0) Xm = 100;

            const Z1 = new Complex(R1, X1);
            const Zm = new Complex((Rc * Xm * Xm)/(Rc**2 + Xm**2), (Rc * Rc * Xm)/(Rc**2 + Xm**2));
            const Z2 = new Complex(R2/s_rated, X2);
            const Z_par = Zm.mul(Z2).div(Zm.add(Z2));
            const Z_total = Z1.add(Z_par);
            const V_phasor = new Complex(V_rated_phase, 0); 
            const I1_c = V_phasor.div(Z_total);
            const E1_c = V_phasor.sub(I1_c.mul(Z1));
            const I2_c = E1_c.div(Z2);

            // --- Power Flow based on User Input (Loss Segregation) ---
            const P_in_chart = P_in_rated_kw * 1000;
            // Use MEASURED Rated Current (Phase) for Copper Loss
            const P_cu1_chart = 3 * (I_rated_phase ** 2) * R1;
            const P_core_chart = P_core_const;
            const P_gap_chart = P_in_chart - P_cu1_chart - P_core_chart;
            const P_cu2_chart = Math.max(0, P_gap_chart * s_rated);
            const P_mech_chart = P_gap_chart - P_cu2_chart;
            const P_out_target_chart = P_out_rated_kw * 1000;
            
            // Merged Friction & Stray Loss: The residual to match output power
            // P_combined_loss = P_mech - P_out_target
            let P_combined_loss = P_mech_chart - P_out_target_chart;
            if (P_combined_loss < 0) P_combined_loss = 0; // Simple clamp
            
            const P_out_final_display = P_out_target_chart; 
            const eff_display = P_in_chart > 0 ? (P_out_final_display / P_in_chart) * 100 : 0;

            document.getElementById('val-r1-svg').textContent = `${R1.toFixed(3)}Ω`;
            document.getElementById('val-x1-svg').textContent = `${X1.toFixed(3)}Ω`;
            document.getElementById('val-rc-svg').textContent = `${Rc.toFixed(0)}Ω`;
            document.getElementById('val-xm-svg').textContent = `${Xm.toFixed(3)}Ω`;
            document.getElementById('val-x2-svg').textContent = `${X2.toFixed(3)}Ω`;
            document.getElementById('val-r2s-svg').textContent = `${(R2/s_rated).toFixed(2)}Ω`;

            document.getElementById('list-r1').textContent = R1.toFixed(3);
            document.getElementById('list-r2').textContent = R2.toFixed(3);
            document.getElementById('list-x1').textContent = X1.toFixed(3);
            document.getElementById('list-l1').textContent = ((X1/omega)*1000).toFixed(2);
            document.getElementById('list-x2').textContent = X2.toFixed(3);
            document.getElementById('list-l2').textContent = ((X2/omega)*1000).toFixed(2);
            document.getElementById('list-xm').textContent = Xm.toFixed(3);
            document.getElementById('list-lm').textContent = ((Xm/omega)*1000).toFixed(2);

            // Update Chart
            document.getElementById('svg-val-pin').textContent = P_in_chart.toFixed(0) + " W";
            document.getElementById('svg-val-pg').textContent = P_gap_chart.toFixed(0) + " W";
            document.getElementById('svg-val-pm').textContent = P_mech_chart.toFixed(0) + " W";
            document.getElementById('svg-val-pout').textContent = P_out_final_display.toFixed(0) + " W";
            document.getElementById('svg-val-pcu1').textContent = P_cu1_chart.toFixed(0) + " W";
            document.getElementById('svg-val-pcore').textContent = P_core_chart.toFixed(0) + " W";
            document.getElementById('svg-val-pcu2').textContent = P_cu2_chart.toFixed(0) + " W";
            // Display combined loss
            document.getElementById('svg-val-pfw').textContent = P_combined_loss.toFixed(0) + " W";
            
            document.getElementById('val-eff').textContent = eff_display.toFixed(2) + " %";

            // Trigger animations
            document.getElementById('anim1').beginElement();
            document.getElementById('anim2').beginElement();
            document.getElementById('anim3').beginElement();
        }
        window.onload = calculate;
    </script>
</body>
</html>